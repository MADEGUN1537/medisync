<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíäMedisync: Medication Reminder & Health Tracker</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4CB5AB;
            --accent: #FF8566;
            --background: #F7F9FA;
            --text: #333A40;
            --gradient: linear-gradient(135deg, #4CB5AB, #66d9cc);
            --error: #e74c3c;
            --success: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Open Sans', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }

        .header {
            background: var(--gradient);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nav a {
            color: var(--text);
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1.1em;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s ease, color 0.3s ease;
            cursor: pointer;
        }

        .nav a:hover {
            background: var(--primary);
            color: white;
        }

        .nav a.active {
            background: var(--primary);
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .medication-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .medication-card.upcoming {
            opacity: 0.6;
        }

        .medication-card.ready {
            opacity: 1;
            font-weight: bold;
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .medication-header h4 {
            font-size: 1.3em;
            color: var(--text);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .status-upcoming {
            background: #3498db;
            color: white;
        }

        .status-completed {
            background: var(--success);
            color: white;
        }

        .status-not-taken {
            background: var(--error);
            color: white;
        }

        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .medication-details p {
            margin: 5px 0;
        }

        .medication-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--gradient);
            transition: width 0.5s ease;
        }

        .add-btn {
            background: var(--accent);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            position: fixed;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .btn {
            background: var(--gradient);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .delete-btn {
            background: var(--error);
        }

        .mark-done-btn {
            background: var(--success);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .modal-content input:focus, .modal-content select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
        }

        .toast.error {
            background: var(--error);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background: var(--text);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .vitals-form, .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .vitals-form label, .profile-form label {
            display: block;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .vitals-form input, .profile-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .vitals-form input:focus, .profile-form input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(76, 181, 171, 0.3);
            outline: none;
        }

        .vitals-form .full-width, .profile-form .full-width {
            grid-column: span 2;
        }

        .vitals-form .error-message, .profile-form .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            padding: 8px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        .time-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-input-container input {
            flex-grow: 1;
        }

        .add-time-btn {
            background: var(--accent);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-time-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .duration-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .duration-container label {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--text);
        }

        .profile-details {
            margin-bottom: 20px;
        }

        .profile-details p {
            font-size: 1em;
            margin: 10px 0;
        }

        .profile-details button {
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
        }

        .profile-details button:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .nav a {
                padding: 8px 15px;
            }

            .add-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .vitals-form, .profile-form {
                grid-template-columns: 1fr;
            }

            .vitals-form .full-width, .profile-form .full-width {
                grid-column: span 1;
            }

            .medication-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üíäMedisync</h1>
            <p style="font-size: 1em; opacity: 0.9;">Your Health, Our Priority</p>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
    <div class="container">
        <div class="nav">
            <a href="#medications" data-page="medications-page" class="active">Medications</a>
            <a href="#vitals" data-page="vitals-page">Vitals</a>
            <a href="#insights" data-page="insights-page">Insights</a>
            <a href="#profile" data-page="profile-page">Profile</a>
        </div>

        <div id="medications-page" class="page active">
            <div class="card" id="medication-tracker">
                <h2>Medication Tracker</h2>
                <div id="medication-list"></div>
                <p class="error-message" id="medication-error"></p>
            </div>
            <div class="add-btn" id="add-medication-btn">+</div>
        </div>

        <div id="vitals-page" class="page">
            <div class="card" id="vitals-tracker">
                <h2>Vital Signs</h2>
                <div class="tooltip">
                    <span>What's normal BP?</span>
                    <span class="tooltiptext">Normal BP is typically 120/80 mmHg.</span>
                </div>
                <form id="vitals-form" class="vitals-form">
                    <div>
                        <label for="bp-systolic">Systolic BP (mmHg)</label>
                        <input type="number" id="bp-systolic" placeholder="e.g., 120" min="0" required>
                        <p class="error-message" id="bp-systolic-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <div>
                        <label for="bp-diastolic">Diastolic BP (mmHg)</label>
                        <input type="number" id="bp-diastolic" placeholder="e.g., 80" min="0" required>
                        <p class="error-message" id="bp-diastolic-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <div>
                        <label for="sugar">Blood Sugar (mg/dL)</label>
                        <input type="number" id="sugar" placeholder="e.g., 100" min="0" required>
                        <p class="error-message" id="sugar-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <div>
                        <label for="heart-rate">Heart Rate (bpm)</label>
                        <input type="number" id="heart-rate" placeholder="e.g., 70" min="0" required>
                        <p class="error-message" id="heart-rate-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <div>
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="e.g., 70" min="0" step="0.1" required>
                        <p class="error-message" id="weight-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <div>
                        <label for="temp">Temperature (¬∞C)</label>
                        <input type="number" id="temp" placeholder="e.g., 36.6" min="0" step="0.1" required>
                        <p class="error-message" id="temp-error">Please enter a valid number (‚â•0).</p>
                    </div>
                    <button type="submit" class="btn full-width">Log Vitals</button>
                </form>
                <canvas id="vitals-chart" style="margin-top: 20px;"></canvas>
            </div>
        </div>

        <div id="insights-page" class="page">
            <div class="card" id="insights">
                <h2>Health Insights</h2>
                <div id="insights-content"></div>
            </div>
            <button class="btn" id="export-pdf-btn">Export Health Report</button>
        </div>

        <div id="profile-page" class="page">
            <div class="card" id="profile">
                <h2>User Profile</h2>
                <div class="profile-details" id="profile-details"></div>
                <form id="profile-form" class="profile-form" style="display: none;">
                    <div>
                        <label for="first-name">First Name</label>
                        <input type="text" id="first-name" placeholder="e.g., John" required>
                        <p class="error-message" id="first-name-error">Please enter a valid first name.</p>
                    </div>
                    <div>
                        <label for="last-name">Last Name</label>
                        <input type="text" id="last-name" placeholder="e.g., Doe" required>
                        <p class="error-message" id="last-name-error">Please enter a valid last name.</p>
                    </div>
                    <div>
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="e.g., john@example.com" required>
                        <p class="error-message" id="email-error">Please enter a valid email address.</p>
                    </div>
                    <div>
                        <label for="phone-number">Phone Number</label>
                        <input type="tel" id="phone-number" placeholder="e.g., +1234567890" pattern="\\+\\d{10,15}" required>
                        <p class="error-message" id="phone-number-error">Please enter a valid phone number (e.g., +1234567890).</p>
                    </div>
                    <div>
                        <label for="password">New Password</label>
                        <input type="password" id="password" placeholder="Enter new password" minlength="8">
                        <p class="error-message" id="password-error">Password must be at least 8 characters long.</p>
                    </div>
                    <div>
                        <label for="confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" placeholder="Confirm new password">
                        <p class="error-message" id="confirm-password-error">Passwords do not match.</p>
                    </div>
                    <div class="full-width">
                        <button type="submit" class="btn">Save Changes</button>
                        <button type="button" class="btn" id="cancel-profile-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="add-medication-modal">
            <div class="modal-content">
                <h2>Add Medication</h2>
                <form id="medication-form">
                    <input type="text" id="med-name" placeholder="Medication Name" required>
                    <input type="text" id="med-dosage" placeholder="Dosage (e.g., 500mg)" required>
                    <select id="med-frequency" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                    <div class="duration-container">
                        <label id="duration-label">Duration</label>
                        <input type="number" id="med-duration" placeholder="e.g., 7" min="1" required>
                        <span id="duration-unit">days</span>
                    </div>
                    <div id="time-inputs">
                        <div class="time-input-container">
                            <input type="time" class="med-time" required>
                        </div>
                    </div>
                    <button type="button" class="add-time-btn" id="add-time-btn">+</button>
                    <p class="error-message" id="medication-form-error"></p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button type="submit" class="btn">Save</button>
                        <button type="button" class="btn" id="cancel-medication-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="toast" id="action-toast"></div>
    </div>

<script type="module">
    import { auth, db, getDoc, doc, saveMedicationToFirebase, saveVitalsToFirebase, deleteMedicationFromFirebase, collection, query, where, onSnapshot, setDoc, updatePassword } from './firebase.js';

    // Initialize Service Worker for offline support
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(reg => {
            console.log('Service Worker registered:', reg);
        }).catch(err => {
            console.error('Service Worker registration failed:', err);
        });
    }

    // Initialize IndexedDB for offline storage
    let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    let dbRequest = indexedDB.open('MedisyncDB', 1);
    let offlineDb;

    dbRequest.onupgradeneeded = function(event) {
        offlineDb = event.target.result;
        if (!offlineDb.objectStoreNames.contains('reminders')) {
            offlineDb.createObjectStore('reminders', { keyPath: 'id', autoIncrement: true });
        }
    };

    dbRequest.onsuccess = function(event) {
        offlineDb = event.target.result;
        console.log('IndexedDB initialized');
        syncOfflineReminders(); // Call sync function after DB initialization
    };

    dbRequest.onerror = function(event) {
        console.error('IndexedDB initialization failed:', event.target.error);
    };

    // Send SMS function (defined early to avoid reference errors)
    let userPhone = null; // Will be set after auth state changes
    async function sendSMS(message) {
        if (!userPhone || !/^\+\d{10,15}$/.test(userPhone)) {
            console.error('Invalid or missing user phone number:', userPhone);
            return;
        }
        try {
            const response = await fetch('https://medisync-backend-1-o8mt.onrender.com/send-sms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer my-unique-token-123'
                },
                body: JSON.stringify({ to: userPhone, body: message })
            });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }
            const result = await response.json();
            console.log('SMS sent successfully:', result.sid);
        } catch (error) {
            console.error('Error sending SMS:', error.message);
            throw error;
        }
    }

    // Function to store reminders in IndexedDB
    async function storeReminderOffline(med) {
        const transaction = offlineDb.transaction(['reminders'], 'readwrite');
        const store = transaction.objectStore('reminders');
        const reminder = {
            medId: med.id,
            name: med.name,
            dosage: med.dosage,
            times: med.times,
            frequency: med.frequency,
            lastReminder: med.lastReminder,
            reminderSent: false
        };
        store.put(reminder);
    }

    // Function to sync offline reminders when online
    async function syncOfflineReminders() {
        if (!navigator.onLine) return;
        const transaction = offlineDb.transaction(['reminders'], 'readwrite');
        const store = transaction.objectStore('reminders');
        const request = store.getAll();
        request.onsuccess = async function(event) {
            const reminders = event.target.result;
            for (const reminder of reminders) {
                if (!reminder.reminderSent) {
                    try {
                        await sendSMS(`Time to take ${reminder.name} (${reminder.dosage})`);
                        reminder.reminderSent = true;
                        store.put(reminder);
                    } catch (error) {
                        console.error('Error syncing reminder:', error);
                    }
                }
            }
        };
        request.onerror = function(event) {
            console.error('Error fetching offline reminders:', event.target.error);
        };
    }

    document.addEventListener("DOMContentLoaded", () => {
        let userId = null;
        let userProfile = { firstName: '', lastName: '', email: '', phoneNumber: '' };
        let sentReminders = new Set(); // Track sent reminders to prevent duplicates

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        userPhone = userProfile.phoneNumber;
                        updateProfileDisplay();
                    }
                    syncOfflineReminders();
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showToast("Failed to load profile", true);
                }
                setupRealtimeListeners();
            } else {
                window.location.href = "login.html";
            }
        });

        gsap.from(".header", { duration: 1, y: -50, opacity: 0, ease: "power2.out" });
        gsap.from(".container", { duration: 1, y: 50, opacity: 0, ease: "power2.out", delay: 0.2 });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                document.querySelector(`.nav a[data-page="${pageId}"]`).classList.add('active');
                gsap.from(`#${pageId}`, { duration: 0.5, opacity: 0, y: 20, ease: "power2.out" });
                if (pageId === "insights-page") {
                    analyzeVitals();
                } else if (pageId === "profile-page") {
                    updateProfileDisplay();
                }
            }
        }

        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                showPage(pageId);
            });
        });

        document.getElementById("logout-btn").addEventListener("click", () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            }).catch(() => {});
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById("action-toast");
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.style.display = "block";
            gsap.fromTo(toast, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" });
            setTimeout(() => {
                gsap.to(toast, { opacity: 0, y: 20, duration: 0.5, ease: "power2.in", onComplete: () => {
                    toast.style.display = "none";
                }});
            }, 3000);
        }

        function updateProfileDisplay() {
            const profileDetails = document.getElementById("profile-details");
            const fullName = `${userProfile.firstName || 'Not set'} ${userProfile.lastName || ''}`.trim();
            profileDetails.innerHTML = `
                <p><strong>Full Name:</strong> ${fullName || 'Not set'} <button class="edit-profile-btn" data-field="name">Edit</button></p>
                <p><strong>Email:</strong> ${userProfile.email || 'Not set'} <button class="edit-profile-btn" data-field="email">Edit</button></p>
                <p><strong>Phone Number:</strong> ${userPhone || 'Not set'} <button class="edit-profile-btn" data-field="phoneNumber">Change</button></p>
                <p><strong>Password:</strong> ******** <button class="edit-profile-btn" data-field="password">Change Password</button></p>
            `;
            document.querySelectorAll(".edit-profile-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const field = btn.getAttribute("data-field");
                    showProfileEditForm(field);
                });
            });
            document.getElementById("profile-form").style.display = "none";
        }

        function showProfileEditForm(field) {
            const form = document.getElementById("profile-form");
            const firstNameInput = document.getElementById("first-name");
            const lastNameInput = document.getElementById("last-name");
            const emailInput = document.getElementById("email");
            const phoneInput = document.getElementById("phone-number");
            const passwordInput = document.getElementById("password");
            const confirmPasswordInput = document.getElementById("confirm-password");
            firstNameInput.value = userProfile.firstName || '';
            lastNameInput.value = userProfile.lastName || '';
            emailInput.value = userProfile.email || '';
            phoneInput.value = userPhone || '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            if (field === "name") {
                firstNameInput.focus();
            } else if (field === "email") {
                emailInput.focus();
            } else if (field === "phoneNumber") {
                phoneInput.focus();
            } else if (field === "password") {
                passwordInput.focus();
            }
            form.style.display = "grid";
            document.querySelectorAll(".profile-form .error-message").forEach(error => error.style.display = "none");
            gsap.from(form, { duration: 0.5, scale: 0.95, opacity: 0, ease: "power2.out" });
        }

        document.getElementById("profile-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const firstName = document.getElementById("first-name").value.trim();
            const lastName = document.getElementById("last-name").value.trim();
            const email = document.getElementById("email").value.trim();
            const phoneNumber = document.getElementById("phone-number").value.trim();
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            let isValid = true;

            if (!/^[A-Za-z\s]+$/.test(firstName)) {
                document.getElementById("first-name-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("first-name-error").style.display = "none";
            }

            if (!/^[A-Za-z\s]+$/.test(lastName)) {
                document.getElementById("last-name-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("last-name-error").style.display = "none";
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById("email-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("email-error").style.display = "none";
            }

            if (!/^\+\d{10,15}$/.test(phoneNumber)) {
                document.getElementById("phone-number-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("phone-number-error").style.display = "none";
            }

            if (password && password.length < 8) {
                document.getElementById("password-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("password-error").style.display = "none";
            }

            if (password && password !== confirmPassword) {
                document.getElementById("confirm-password-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("confirm-password-error").style.display = "none";
            }

            if (!isValid) return;

            try {
                await setDoc(doc(db, "users", userId), {
                    firstName,
                    lastName,
                    email,
                    phoneNumber
                }, { merge: true });
                if (password) {
                    await updatePassword(auth.currentUser, password);
                }
                userProfile.firstName = firstName;
                userProfile.lastName = lastName;
                userProfile.email = email;
                userPhone = phoneNumber;
                updateProfileDisplay();
                showToast("Profile updated successfully");
            } catch (error) {
                document.getElementById("phone-number-error").textContent = `Failed to update profile: ${error.message}`;
                document.getElementById("phone-number-error").style.display = "block";
                showToast("Failed to update profile", true);
            }
        });

        document.getElementById("cancel-profile-btn").addEventListener("click", () => {
            document.getElementById("profile-form").style.display = "none";
            updateProfileDisplay();
        });

        let medications = [];
        function setupRealtimeListeners() {
            const medQuery = query(collection(db, "medications"), where("userId", "==", userId));
            onSnapshot(medQuery, (snapshot) => {
                medications = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.times = Array.isArray(data.times) ? data.times : [];
                    medications.push({ 
                        id: doc.id, 
                        ...data, 
                        status: data.status || "upcoming", 
                        progress: data.progress || 0, 
                        lastChecked: data.lastChecked || null,
                        duration: data.duration || null,
                        endDate: data.endDate || null,
                        missedDoses: data.missedDoses || 0,
                        lastReminder: data.lastReminder || null,
                        completedDoses: data.completedDoses || []
                    });
                });
                updateMedicationList();
                checkMissedMedications();
            }, () => {});

            const vitalsQuery = query(collection(db, "vitals"), where("userId", "==", userId));
            onSnapshot(vitalsQuery, (snapshot) => {
                vitalsData = [];
                snapshot.forEach(doc => vitalsData.push(doc.data()));
                updateVitalsChart();
                analyzeVitals();
            }, () => {});
        }

        function showAddMedicationModal() {
            document.getElementById("add-medication-modal").style.display = "flex";
            document.getElementById("medication-form-error").style.display = "none";
            updateDurationLabel();
            gsap.from(".modal-content", { duration: 0.5, scale: 0.8, opacity: 0, ease: "power2.out" });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
            document.getElementById("time-inputs").innerHTML = `
                <div class="time-input-container">
                    <input type="time" class="med-time" required>
                </div>
            `;
            document.getElementById("medication-form").reset();
            document.getElementById("medication-form-error").style.display = "none";
            updateDurationLabel();
        }

        function updateDurationLabel() {
            const frequency = document.getElementById("med-frequency").value;
            document.getElementById("duration-unit").textContent = frequency === "daily" ? "days" : "weeks";
        }

        document.getElementById("add-medication-btn").addEventListener("click", showAddMedicationModal);
        document.getElementById("cancel-medication-btn").addEventListener("click", () => closeModal("add-medication-modal"));
        document.getElementById("med-frequency").addEventListener("change", updateDurationLabel);

        document.getElementById("add-time-btn").addEventListener("click", () => {
            const timeInputs = document.getElementById("time-inputs");
            const newTimeInput = document.createElement("div");
            newTimeInput.className = "time-input-container";
            newTimeInput.innerHTML = `<input type="time" class="med-time" required>`;
            timeInputs.appendChild(newTimeInput);
            gsap.from(newTimeInput, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out" });
        });

        document.getElementById("medication-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const errorMessage = document.getElementById("medication-form-error");
            errorMessage.style.display = "none";
            const timeInputs = document.querySelectorAll(".med-time");
            const times = Array.from(timeInputs).map(input => input.value).filter(time => time);
            const duration = Number(document.getElementById("med-duration").value);
            if (times.length === 0) {
                errorMessage.textContent = "Please add at least one valid time.";
                errorMessage.style.display = "block";
                return;
            }
            if (isNaN(duration) || duration < 1) {
                errorMessage.textContent = "Please enter a valid duration (‚â•1).";
                errorMessage.style.display = "block";
                return;
            }
            const frequency = document.getElementById("med-frequency").value;
            const endDate = new Date();
            if (frequency === "daily") {
                endDate.setDate(endDate.getDate() + duration);
            } else {
                endDate.setDate(endDate.getDate() + duration * 7);
            }
            const med = {
                name: document.getElementById("med-name").value,
                dosage: document.getElementById("med-dosage").value,
                frequency: frequency,
                times: times,
                status: "upcoming",
                progress: 0,
                lastChecked: null,
                duration: duration,
                createdAt: new Date().toISOString(),
                endDate: endDate.toISOString(),
                missedDoses: 0,
                lastReminder: null,
                completedDoses: []
            };
            try {
                await saveMedicationToFirebase(med);
                storeReminderOffline(med); // Store for offline use
                closeModal("add-medication-modal");
                document.getElementById("medication-form").reset();
                showToast("Medication added successfully");
            } catch (error) {
                errorMessage.textContent = error.message.includes("No authenticated user") ? 
                    "Please log in again to save medications." : 
                    error.message.includes("permission-denied") ? 
                    "Permission denied. Please ensure you are logged in with the correct account." : 
                    `Failed to save medication: ${error.message}`;
                errorMessage.style.display = "block";
                showToast("Failed to add medication", true);
            }
        });

        function updateMedicationList() {
            const list = document.getElementById("medication-list");
            const errorMessage = document.getElementById("medication-error");
            list.innerHTML = "";
            errorMessage.style.display = "none";
            const now = new Date();
            let validMedications = 0;
            medications.forEach((med, index) => {
                if (!Array.isArray(med.times) || med.times.length === 0 || !med.times.every(time => typeof time === 'string')) {
                    const div = document.createElement("div");
                    div.className = "medication-card";
                    div.innerHTML = `
                        <div class="medication-header">
                            <h4>‚ö†Ô∏è ${med.name}</h4>
                            <span class="status-badge status-not-taken">Invalid Data</span>
                        </div>
                        <p>Invalid times data. Please delete and re-add this medication.</p>
                        <div class="medication-actions">
                            <button class="btn delete-btn" data-id="${med.id}">Delete</button>
                        </div>
                    `;
                    list.appendChild(div);
                    gsap.from(div, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out", delay: index * 0.1 });
                    return;
                }
                validMedications++;
                const isTimeToTake = isWithinTimeWindow(med, now);
                const timesDisplay = med.times.join(", ");
                const nextTime = getNextMedicationTime(med);
                let remainingText = "";
                if (med.endDate) {
                    const startDate = new Date(med.createdAt || now);
                    const endDate = new Date(med.endDate);
                    const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
                    const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    const daysRemaining = Math.max(0, totalDuration - daysPassed);
                    const unit = med.frequency === "daily" ? "days" : "weeks";
                    if (daysRemaining <= 0 && med.status !== "completed") {
                        med.status = "completed";
                        med.progress = 100;
                        setDoc(doc(db, "medications", med.id), med).catch(() => {});
                    }
                    remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "Completed";
                }
                const div = document.createElement("div");
                div.className = `medication-card ${isTimeToTake ? 'ready' : 'upcoming'}`;
                div.innerHTML = `
                    <div class="medication-header">
                        <h4>${med.name}</h4>
                        <span class="status-badge status-${med.status.replace(' ', '-')}">${med.status.charAt(0).toUpperCase() + med.status.slice(1)}</span>
                    </div>
                    <div class="medication-details">
                        <p><strong>Dosage:</strong> ${med.dosage}</p>
                        <p><strong>Frequency:</strong> ${med.frequency.charAt(0).toUpperCase() + med.frequency.slice(1)}</p>
                        <p><strong>Times:</strong> ${timesDisplay}${isTimeToTake ? "" : `, Next: ${nextTime || 'N/A'}`}</p>
                        <p><strong>Remaining:</strong> ${remainingText}</p>
                        <p><strong>Missed Doses:</strong> <span style="color: ${med.missedDoses > 0 ? 'var(--error)' : 'inherit'}">${med.missedDoses || 0}</span></p>
                    </div>
                    <div class="progress-bar"><div class="progress" style="width: ${med.progress}%"></div></div>
                    <div class="medication-actions">
                        ${isTimeToTake ? `<button class="btn mark-done-btn" data-index="${index}" data-id="${med.id}">Mark as Taken</button>` : ''}
                        <button class="btn delete-btn" data-id="${med.id}">Delete</button>
                    </div>
                `;
                list.appendChild(div);
                gsap.from(div, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out", delay: index * 0.1 });

                if (isTimeToTake) {
                    const markBtn = div.querySelector('.mark-done-btn');
                    markBtn.addEventListener('click', () => markCompleted(index));
                }
            });
            if (medications.length === 0) {
                list.innerHTML = `<p style="text-align: center; color: var(--text); opacity: 0.7;">No medications found. Add a new medication using the "+" button.</p>`;
                gsap.from(list, { duration: 0.5, opacity: 0, ease: "power2.out" });
            } else if (validMedications === 0 && medications.length > 0) {
                errorMessage.textContent = "No valid medications found. Please delete invalid entries or add new medications.";
                errorMessage.style.display = "block";
                gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
            }

            document.querySelectorAll(".mark-done-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.getAttribute("data-index"));
                    markCompleted(index);
                });
            });

            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const docId = btn.getAttribute("data-id");
                    try {
                        await deleteMedicationFromFirebase(docId);
                        // Remove from IndexedDB
                        const transaction = offlineDb.transaction(['reminders'], 'readwrite');
                        const store = transaction.objectStore('reminders');
                        store.delete(docId);
                        showToast("Medication deleted successfully");
                    } catch (error) {
                        errorMessage.textContent = `Failed to delete medication: ${error.message}`;
                        errorMessage.style.display = "block";
                        gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
                        showToast("Failed to delete medication", true);
                    }
                });
            });
        }

        function getNextMedicationTime(med) {
            if (!Array.isArray(med.times) || med.times.length === 0) {
                return null;
            }
            const now = new Date();
            let nextTime = null;
            med.times.forEach(time => {
                if (typeof time !== 'string') return;
                try {
                    const [hours, minutes] = time.split(":").map(Number);
                    if (isNaN(hours) || isNaN(minutes)) return;
                    const medTime = new Date();
                    medTime.setHours(hours, minutes, 0, 0);
                    if (medTime > now && (!nextTime || medTime < nextTime)) {
                        nextTime = medTime;
                    }
                } catch (error) {}
            });
            if (!nextTime && med.frequency === "daily") {
                const firstTime = med.times.find(time => typeof time === 'string');
                if (firstTime) {
                    try {
                        const [hours, minutes] = firstTime.split(":").map(Number);
                        if (!isNaN(hours) && !isNaN(minutes)) {
                            nextTime = new Date();
                            nextTime.setDate(nextTime.getDate() + 1);
                            nextTime.setHours(hours, minutes, 0, 0);
                        }
                    } catch (error) {}
                }
            }
            return nextTime ? nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : null;
        }

        function isWithinTimeWindow(med, now) {
            if (!Array.isArray(med.times) || med.times.length === 0) {
                return false;
            }
            return med.times.some(time => {
                if (typeof time !== 'string') return false;
                try {
                    const [hours, minutes] = time.split(":").map(Number);
                    if (isNaN(hours) || isNaN(minutes)) return false;
                    const medTime = new Date();
                    medTime.setHours(hours, minutes, 0, 0);
                    const windowStart = new Date(medTime.getTime() - 5 * 60 * 1000); // 5 minutes before
                    const windowEnd = new Date(medTime.getTime() + 3 * 60 * 60 * 1000); // 3 hours after
                    return now >= windowStart && now <= windowEnd && med.status === "upcoming";
                } catch (error) {
                    return false;
                }
            });
        }

        async function markCompleted(index) {
            const med = medications[index];
            if (!med) return;
            const now = new Date();
            med.completedDoses = med.completedDoses || [];
            med.completedDoses.push(now.toISOString());
            med.lastChecked = now.toISOString();
            const totalDoses = calculateTotalDoses(med);
            med.progress = totalDoses > 0 ? (med.completedDoses.length / totalDoses * 100) : 0;
            med.status = med.progress >= 100 ? "completed" : "upcoming";
            try {
                await setDoc(doc(db, "medications", med.id), med);
                showToast(`Dose marked as taken for ${med.name}`);
            } catch (error) {
                const errorMessage = document.getElementById("medication-error");
                errorMessage.textContent = `Failed to update medication status: ${error.message}`;
                errorMessage.style.display = "block";
                gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
                showToast("Failed to mark dose", true);
            }
        }

        function calculateTotalDoses(med) {
            if (!med.createdAt || !med.endDate || !med.times) return 0;
            const startDate = new Date(med.createdAt);
            const endDate = new Date(med.endDate);
            const now = new Date();
            const effectiveEndDate = now < endDate ? now : endDate;
            const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            return med.frequency === "daily" ? days * med.times.length : Math.floor(days / 7) * med.times.length;
        }

        async function checkMedicationReminders() {
            const now = new Date();
            for (const med of medications) {
                if (med.status === "completed" || !med.times || !Array.isArray(med.times) || med.times.length === 0) continue;
                for (const time of med.times) {
                    if (typeof time !== 'string') continue;
                    try {
                        const [hours, minutes] = time.split(":").map(Number);
                        if (isNaN(hours) || isNaN(minutes)) continue;
                        const medTime = new Date();
                        medTime.setHours(hours, minutes, 0, 0);
                        const reminderTime = new Date(medTime.getTime() - 5 * 60 * 1000); // 5 minutes before
                        const windowStart = new Date(reminderTime.getTime() - 30 * 1000);
                        const windowEnd = new Date(reminderTime.getTime() + 30 * 1000);
                        const reminderKey = `${med.id}-${time}-${medTime.toDateString()}`;
                        if (sentReminders.has(reminderKey)) continue; // Skip if reminder already sent
                        if (now >= windowStart && now <= windowEnd) {
                            if (navigator.onLine) {
                                const message = `Time to take ${med.name} (${med.dosage}) at ${time}. Reply 'Yes' to confirm, 'No' to skip.`;
                                await sendSMS(message);
                                med.lastReminder = now.toISOString();
                                await setDoc(doc(db, "medications", med.id), med).catch(() => {});
                                sentReminders.add(reminderKey);
                            } else {
                                // Store reminder in IndexedDB for offline
                                storeReminderOffline(med);
                                showToast(`Offline reminder: Time to take ${med.name} (${med.dosage}) at ${time}`);
                            }
                        }
                    } catch (error) {}
                }
            }
        }

        async function checkMissedMedications() {
            const now = new Date();
            for (const med of medications) {
                if (med.status === "completed" || !Array.isArray(med.times) || med.times.length === 0) continue;
                let updated = false;
                let missedDoses = med.missedDoses || 0;
                const startDate = new Date(med.createdAt || now);
                const endDate = new Date(med.endDate);
                const effectiveEndDate = now < endDate ? now : endDate;
                const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                for (let day = 0; day < days; day++) {
                    if (med.frequency === "weekly" && day % 7 !== 0) continue;
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + day);
                    for (const time of med.times) {
                        if (typeof time !== 'string') continue;
                        try {
                            const [hours, minutes] = time.split(":").map(Number);
                            if (isNaN(hours) || isNaN(minutes)) continue;
                            const doseTime = new Date(currentDate);
                            doseTime.setHours(hours, minutes, 0, 0);
                            const missedWindow = new Date(doseTime.getTime() + 3 * 60 * 60 * 1000); // 3 hours after
                            if (now <= missedWindow || doseTime > now) continue;

                            const completed = med.completedDoses && med.completedDoses.some(completedTime => {
                                const completedDate = new Date(completedTime);
                                return completedDate.toDateString() === doseTime.toDateString() &&
                                       completedDate.getHours() === doseTime.getHours() &&
                                       completedDate.getMinutes() === doseTime.getMinutes();
                            });

                            if (!completed) {
                                missedDoses++;
                                updated = true;
                            }
                        } catch (error) {}
                    }
                }

                if (med.missedDoses !== missedDoses) {
                    med.missedDoses = missedDoses;
                    med.status = missedDoses > 0 ? "not taken" : "upcoming";
                    updated = true;
                }

                if (updated) {
                    try {
                        await setDoc(doc(db, "medications", med.id), med);
                    } catch (error) {
                        const errorMessage = document.getElementById("medication-error");
                        errorMessage.textContent = `Failed to update medication status: ${error.message}`;
                        errorMessage.style.display = "block";
                        gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
                        showToast("Failed to update medication status", true);
                    }
                }
            }
            updateMedicationList();
        }

        let vitalsData = [];
        const ctx = document.getElementById("vitals-chart").getContext("2d");
        const vitalsChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    { label: "Systolic BP (mmHg)", data: [], borderColor: "#4CB5AB", fill: false },
                    { label: "Diastolic BP (mmHg)", data: [], borderColor: "#FF8566", fill: false },
                    { label: "Blood Sugar (mg/dL)", data: [], borderColor: "#333A40", fill: false },
                    { label: "Heart Rate (bpm)", data: [], borderColor: "#8e44ad", fill: false },
                    { label: "Weight (kg)", data: [], borderColor: "#e67e22", fill: false },
                    { label: "Temperature (¬∞C)", data: [], borderColor: "#2ecc71", fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        document.getElementById("vitals-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const inputs = [
                { id: "bp-systolic", value: Number(document.getElementById("bp-systolic").value) },
                { id: "bp-diastolic", value: Number(document.getElementById("bp-diastolic").value) },
                { id: "sugar", value: Number(document.getElementById("sugar").value) },
                { id: "heart-rate", value: Number(document.getElementById("heart-rate").value) },
                { id: "weight", value: Number(document.getElementById("weight").value) },
                { id: "temp", value: Number(document.getElementById("temp").value) }
            ];
            let isValid = true;
            inputs.forEach(input => {
                const errorElement = document.getElementById(`${input.id}-error`);
                if (input.value < 0 || isNaN(input.value)) {
                    errorElement.style.display = "block";
                    isValid = false;
                } else {
                    errorElement.style.display = "none";
                }
            });
            if (!isValid) return;
            const vitals = {
                systolic: inputs[0].value,
                diastolic: inputs[1].value,
                sugar: inputs[2].value,
                heartRate: inputs[3].value,
                weight: inputs[4].value,
                temp: inputs[5].value,
                timestamp: new Date().toISOString()
            };
            try {
                await saveVitalsToFirebase(vitals);
                document.getElementById("vitals-form").reset();
                gsap.from(".vitals-form", { duration: 0.5, scale: 0.95, opacity: 0, ease: "power2.out" });
                showToast("Vitals logged successfully");
            } catch (error) {
                showToast("Failed to log vitals: " + error.message, true);
            }
        });

        function updateVitalsChart() {
            vitalsChart.data.labels = vitalsData.map(v => new Date(v.timestamp).toLocaleDateString());
            vitalsChart.data.datasets[0].data = vitalsData.map(v => v.systolic);
            vitalsChart.data.datasets[1].data = vitalsData.map(v => v.diastolic);
            vitalsChart.data.datasets[2].data = vitalsData.map(v => v.sugar);
            vitalsChart.data.datasets[3].data = vitalsData.map(v => v.heartRate);
            vitalsChart.data.datasets[4].data = vitalsData.map(v => v.weight);
            vitalsChart.data.datasets[5].data = vitalsData.map(v => v.temp);
            vitalsChart.update();
            gsap.from("#vitals-chart", { duration: 1, opacity: 0, scale: 0.95, ease: "power2.out" });
        }

        async function analyzeVitals() {
            const insights = document.getElementById("insights-content");
            insights.innerHTML = "";
            if (vitalsData.length === 0 && medications.length === 0) {
                insights.innerHTML = `<p style="text-align: center; color: var(--text); opacity: 0.7;">No vitals or medication data available. Please log vitals or add medications to receive insights.</p>`;
                gsap.from(insights, { duration: 0.5, opacity: 0, y: 20, ease: "power2.out" });
                return;
            }
            insights.innerHTML = `
                <h3>Health Summary</h3>
                <p>The following insights are based on your recent vitals and medication adherence data as of ${new Date().toLocaleDateString()}.</p>
            `;
            if (medications.length > 0) {
                const completedMeds = medications.filter(m => m.status === "completed").length;
                const totalMissedDoses = medications.reduce((sum, m) => sum + (m.missedDoses || 0), 0);
                const totalDoses = medications.reduce((sum, m) => sum + calculateTotalDoses(m), 0);
                const completedDoses = medications.reduce((sum, m) => sum + (m.completedDoses ? m.completedDoses.length : 0), 0);
                const adherenceRate = totalDoses > 0 ? (completedDoses / totalDoses * 100).toFixed(1) : 0;
                const overdueMeds = medications.filter(m => m.endDate && new Date(m.endDate) < new Date() && m.status !== "completed");
                insights.innerHTML += `
                    <h4>Medication Adherence</h4>
                    <p><strong>Adherence Rate:</strong> ${adherenceRate}% (${completedDoses} of ${totalDoses} doses marked as completed).</p>
                    <p><strong>Total Missed Doses:</strong> ${totalMissedDoses}</p>
                    ${adherenceRate < 80 ? "<p style='color: var(--error);'>‚ö†Ô∏è Your adherence rate is below 80%. Consistent medication intake is crucial for effective treatment. Consider setting reminders or consulting your healthcare provider.</p>" : "<p style='color: var(--success);'>‚úÖ Excellent adherence! Keep up the consistent medication schedule.</p>"}
                    ${overdueMeds.length > 0 ? `<p style='color: var(--error);'>‚ö†Ô∏è Overdue Medications: ${overdueMeds.map(m => m.name).join(", ")}. These medications have passed their duration. Please review with your doctor.</p>` : ""}
                `;
                if (overdueMeds.length > 0) {
                    const message = `Overdue: ${overdueMeds.map(m => m.name).join(", ")} duration ended on ${new Date(overdueMeds[0].endDate).toLocaleDateString()}. Consult your doctor.`;
                    try {
                        await sendSMS(message);
                    } catch (error) {
                        console.error('Error sending overdue medication SMS:', error);
                    }
                }
            }
            if (vitalsData.length > 0) {
                const recentVitals = vitalsData.slice(-1)[0]; // Latest vital entry
                let warnings = [];

                // Blood Pressure (Systolic/Diastolic)
                if (recentVitals.systolic > 130 || recentVitals.diastolic > 80) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è High blood pressure detected: ${recentVitals.systolic}/${recentVitals.diastolic} mmHg (Normal: <120/80 mmHg). Reduce salt intake, manage stress, and consult a healthcare provider.</p>`);
                } else if (recentVitals.systolic < 90 || recentVitals.diastolic < 60) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Low blood pressure detected: ${recentVitals.systolic}/${recentVitals.diastolic} mmHg (Normal: <120/80 mmHg). Consult a healthcare provider.</p>`);
                } else {
                    warnings.push(`<p style='color: var(--success);'>‚úÖ Blood pressure is within normal range: ${recentVitals.systolic}/${recentVitals.diastolic} mmHg.</p>`);
                }

                // Blood Sugar
                if (recentVitals.sugar > 140) {
                    warnings.push(`<p style='color: var(--error);'>üö® High blood sugar detected: ${recentVitals.sugar} mg/dL (Normal: 70-140 mg/dL). Avoid sugary foods, monitor diet, and consult a doctor.</p>`);
                } else if (recentVitals.sugar < 70) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Low blood sugar detected: ${recentVitals.sugar} mg/dL (Normal: 70-140 mg/dL). Consume fast-acting carbohydrates (e.g., juice) and consult a doctor.</p>`);
                } else {
                    warnings.push(`<p style='color: var(--success);'>‚úÖ Blood sugar is within normal range: ${recentVitals.sugar} mg/dL.</p>`);
                }

                // Heart Rate
                if (recentVitals.heartRate > 100) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è High heart rate detected: ${recentVitals.heartRate} bpm (Normal: 60-100 bpm). Avoid stimulants (e.g., caffeine) and consult a healthcare provider.</p>`);
                } else if (recentVitals.heartRate < 60) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Low heart rate detected: ${recentVitals.heartRate} bpm (Normal: 60-100 bpm). Consult a healthcare provider.</p>`);
                } else {
                    warnings.push(`<p style='color: var(--success);'>‚úÖ Heart rate is within normal range: ${recentVitals.heartRate} bpm.</p>`);
                }

                // Weight (context-dependent, assuming BMI context)
                if (recentVitals.weight > 100) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Elevated weight detected: ${recentVitals.weight} kg. Consider a balanced diet and consult a healthcare provider for personalized advice.</p>`);
                } else if (recentVitals.weight < 40) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Low weight detected: ${recentVitals.weight} kg. Consult a healthcare provider for nutritional guidance.</p>`);
                } else {
                    warnings.push(`<p style='color: var(--success);'>‚úÖ Weight appears stable: ${recentVitals.weight} kg.</p>`);
                }

                // Temperature
                if (recentVitals.temp > 37.2) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è High temperature detected: ${recentVitals.temp} ¬∞C (Normal: 36.1-37.2 ¬∞C). Monitor for fever and consult a doctor if persistent.</p>`);
                } else if (recentVitals.temp < 36.1) {
                    warnings.push(`<p style='color: var(--error);'>‚ö†Ô∏è Low temperature detected: ${recentVitals.temp} ¬∞C (Normal: 36.1-37.2 ¬∞C). Keep warm and consult a healthcare provider.</p>`);
                } else {
                    warnings.push(`<p style='color: var(--success);'>‚úÖ Temperature is within normal range: ${recentVitals.temp} ¬∞C.</p>`);
                }

                // Trend analysis for multiple entries
                if (vitalsData.length > 1) {
                    const avgSystolic = (vitalsData.reduce((sum, v) => sum + v.systolic, 0) / vitalsData.length).toFixed(1);
                    const avgDiastolic = (vitalsData.reduce((sum, v) => sum + v.diastolic, 0) / vitalsData.length).toFixed(1);
                    const avgSugar = (vitalsData.reduce((sum, v) => sum + v.sugar, 0) / vitalsData.length).toFixed(1);
                    const avgHeartRate = (vitalsData.reduce((sum, v) => sum + v.heartRate, 0) / vitalsData.length).toFixed(1);
                    warnings.push(`
                        <h4>Trend Analysis (Averages)</h4>
                        <p><strong>Average Blood Pressure:</strong> ${avgSystolic}/${avgDiastolic} mmHg</p>
                        <p><strong>Average Blood Sugar:</strong> ${avgSugar} mg/dL</p>
                        <p><strong>Average Heart Rate:</strong> ${avgHeartRate} bpm</p>
                        ${avgSystolic > 130 || avgDiastolic > 80 ? "<p style='color: var(--error);'>‚ö†Ô∏è Average blood pressure is elevated. Monitor closely and consult a doctor.</p>" : ""}
                        ${avgSugar > 140 || avgSugar < 70 ? "<p style='color: var(--error);'>‚ö†Ô∏è Average blood sugar is outside normal range. Adjust diet and consult a doctor.</p>" : ""}
                        ${avgHeartRate > 100 || avgHeartRate < 60 ? "<p style='color: var(--error);'>‚ö†Ô∏è Average heart rate is abnormal. Consult a healthcare provider.</p>" : ""}
                    `);
                }

                insights.innerHTML += `
                    <h4>Vital Signs Analysis (Latest Entry: ${new Date(recentVitals.timestamp).toLocaleString()})</h4>
                    ${warnings.join('')}
                    <h4>Recommendations</h4>
                    <ul style="text-align: left;">
                        <li>Log vitals daily to monitor trends effectively.</li>
                        <li>Ensure timely medication intake to maintain adherence above 80%.</li>
                        <li>Schedule a consultation with your healthcare provider if you notice persistent abnormal vitals or missed doses.</li>
                        <li>Maintain a balanced diet and regular physical activity to support overall health.</li>
                    </ul>
                `;

                // Send SMS for critical abnormalities
                if (warnings.some(w => w.includes('var(--error)'))) {
                    const criticalWarnings = warnings
                        .filter(w => w.includes('var(--error)'))
                        .map(w => w.replace(/<[^>]+>/g, '').replace('‚ö†Ô∏è ', '').replace('üö® ', ''))
                        .join(' ');
                    const message = `Health alert: ${criticalWarnings} Please review and consult a doctor.`;
                    try {
                        await sendSMS(message);
                    } catch (error) {
                        console.error('Error sending vitals alert SMS:', error);
                    }
                }
            }
            gsap.from(insights, { duration: 0.5, y: 20, opacity: 0, ease: "power2.out" });
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("helvetica", "bold");
            doc.text("üíäMedisync Health Report", 10, 10);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 10, 20);
            doc.text("Vitals Log:", 10, 30);
            let yPos = 40;
            const vitalsTableData = vitalsData.map(v => [
                new Date(v.timestamp).toLocaleString(),
                v.systolic.toString(),
                v.diastolic.toString(),
                v.sugar.toString(),
                v.heartRate.toString(),
                v.weight.toString(),
                v.temp.toString()
            ]);
            doc.autoTable({
                startY: yPos,
                head: [['Date', 'Systolic BP (mmHg)', 'Diastolic BP (mmHg)', 'Blood Sugar (mg/dL)', 'Heart Rate (bpm)', 'Weight (kg)', 'Temperature (¬∞C)']],
                body: vitalsTableData,
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
                headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[1]) > 130) ? [231, 76, 60] : [51, 58, 64] },
                    2: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[2]) > 80) ? [231, 76, 60] : [51, 58, 64] },
                    3: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[3]) > 140) ? [231, 76, 60] : [51, 58, 64] },
                    4: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[4]) > 100 || Number(row[4]) < 60) ? [231, 76, 60] : [51, 58, 64] },
                    5: { cellWidth: 25, halign: 'center' },
                    6: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[6]) > 37.2 || Number(row[6]) < 36.1) ? [231, 76, 60] : [51, 58, 64] }
                },
                margin: { left: 10, right: 10 }
            });
            yPos = doc.lastAutoTable.finalY + 10;
            doc.text("Medications:", 10, yPos);
            yPos += 10;
            const tableData = medications.map(med => {
                const timesDisplay = Array.isArray(med.times) && med.times.length > 0 && med.times.every(time => typeof time === 'string') ? med.times.join(", ") : "No valid times";
                const startDate = new Date(med.createdAt || new Date());
                const endDate = new Date(med.endDate);
                const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
                const daysPassed = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, totalDuration - daysPassed);
                const unit = med.frequency === "daily" ? "days" : "weeks";
                const remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "Completed";
                const statusText = med.status.charAt(0).toUpperCase() + med.status.slice(1);
                return [
                    med.name,
                    med.dosage,
                    med.frequency.charAt(0).toUpperCase() + med.frequency.slice(1),
                    timesDisplay,
                    statusText,
                    remainingText,
                    med.missedDoses || 0
                ];
            });
            doc.autoTable({
                startY: yPos,
                head: [['Name', 'Dosage', 'Frequency', 'Times', 'Status', 'Remaining', 'Missed Doses']],
                body: tableData,
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
                headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 30 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 25, halign: 'center' },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 20, halign: 'center', textColor: tableData.some(row => row[6] > 0) ? [231, 76, 60] : [51, 58, 64] }
                },
                margin: { left: 10, right: 10 }
            });
            doc.save("Medisync_Health_Report.pdf");
        }

        document.getElementById("export-pdf-btn").addEventListener("click", exportToPDF);

        setInterval(async () => {
            const now = new Date();
            await checkMedicationReminders();
        }, 30000); // Check every 30 seconds
    });
</script>

</body>
</html>
