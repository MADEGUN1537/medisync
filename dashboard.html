<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medisync: Medication Reminder & Health Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4CB5AB;
            --accent: #FF8566;
            --background: #F7F9FA;
            --text: #333A40;
            --gradient: linear-gradient(135deg, #4CB5AB, #66d9cc);
            --error: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Open Sans', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }

        .header {
            background: var(--gradient);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nav a {
            color: var(--text);
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1.1em;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s ease, color 0.3s ease;
            cursor: pointer;
        }

        .nav a:hover {
            background: var(--primary);
            color: white;
        }

        .nav a.active {
            background: var(--primary);
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .medication-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }

        .medication-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .medication-table th, .medication-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 0.9em;
        }

        .medication-table th {
            background: var(--primary);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .medication-table td {
            color: var(--text);
        }

        .medication-table .missed-dose {
            color: var(--error);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress {
            height: 100%;
            background: var(--gradient);
            transition: width 0.5s ease;
        }

        .add-btn {
            background: var(--accent);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            position: fixed;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .btn {
            background: var(--gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .delete-btn {
            background: var(--error);
            padding: 8px 16px;
            margin-left: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .modal-content input:focus, .modal-content select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background: var(--text);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .vitals-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .vitals-form label {
            display: block;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .vitals-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .vitals-form input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(76, 181, 171, 0.3);
            outline: none;
        }

        .vitals-form .full-width {
            grid-column: span 2;
        }

        .vitals-form .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .time-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-input-container input {
            flex-grow: 1;
        }

        .add-time-btn {
            background: var(--accent);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-time-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .duration-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .duration-container label {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--text);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .nav a {
                padding: 8px 15px;
            }

            .add-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .vitals-form {
                grid-template-columns: 1fr;
            }

            .vitals-form .full-width {
                grid-column: span 1;
            }

            .medication-table th, .medication-table td {
                font-size: 0.8em;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1> 💊Medisync</h1>
            <p style="font-size: 1em; opacity: 0.9;">Your Health, Our Priority</p>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
    <div class="container">
        <div class="nav">
            <a href="#medications" data-page="medications-page" class="active">Medications</a>
            <a href="#vitals" data-page="vitals-page">Vitals</a>
            <a href="#insights" data-page="insights-page">Insights</a>
        </div>

        <div id="medications-page" class="page active">
            <div class="card" id="medication-tracker">
                <h2>Medication Tracker</h2>
                <div id="medication-list"></div>
                <p class="error-message" id="medication-error"></p>
            </div>
            <div class="add-btn" id="add-medication-btn">+</div>
        </div>

        <div id="vitals-page" class="page">
            <div class="card" id="vitals-tracker">
                <h2>Vital Signs</h2>
                <div class="tooltip">
                    <span>What's normal BP?</span>
                    <span class="tooltiptext">Normal BP is typically 120/80 mmHg.</span>
                </div>
                <form id="vitals-form" class="vitals-form">
                    <div>
                        <label for="bp-systolic">Systolic BP (mmHg)</label>
                        <input type="number" id="bp-systolic" placeholder="e.g., 120" min="0" required>
                        <p class="error-message" id="bp-systolic-error">Please enter a valid number (≥0).</p>
                    </div>
                    <div>
                        <label for="bp-diastolic">Diastolic BP (mmHg)</label>
                        <input type="number" id="bp-diastolic" placeholder="e.g., 80" min="0" required>
                        <p class="error-message" id="bp-diastolic-error">Please enter a valid number (≥0).</p>
                    </div>
                    <div>
                        <label for="sugar">Blood Sugar (mg/dL)</label>
                        <input type="number" id="sugar" placeholder="e.g., 100" min="0" required>
                        <p class="error-message" id="sugar-error">Please enter a valid number (≥0).</p>
                    </div>
                    <div>
                        <label for="heart-rate">Heart Rate (bpm)</label>
                        <input type="number" id="heart-rate" placeholder="e.g., 70" min="0" required>
                        <p class="error-message" id="heart-rate-error">Please enter a valid number (≥0).</p>
                    </div>
                    <div>
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="e.g., 70" min="0" step="0.1" required>
                        <p class="error-message" id="weight-error">Please enter a valid number (≥0).</p>
                    </div>
                    <div>
                        <label for="temp">Temperature (°C)</label>
                        <input type="number" id="temp" placeholder="e.g., 36.6" min="0" step="0.1" required>
                        <p class="error-message" id="temp-error">Please enter a valid number (≥0).</p>
                    </div>
                    <button type="submit" class="btn full-width">Log Vitals</button>
                </form>
                <canvas id="vitals-chart" style="margin-top: 20px;"></canvas>
            </div>
        </div>

        <div id="insights-page" class="page">
            <div class="card" id="insights">
                <h2>Health Insights</h2>
                <div id="insights-content"></div>
            </div>
            <button class="btn" id="export-pdf-btn">Export Health Report</button>
        </div>

        <div class="modal" id="add-medication-modal">
            <div class="modal-content">
                <h2>Add Medication</h2>
                <form id="medication-form">
                    <input type="text" id="med-name" placeholder="Medication Name" required>
                    <input type="text" id="med-dosage" placeholder="Dosage" required>
                    <select id="med-frequency" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                    <div class="duration-container">
                        <label id="duration-label">Duration</label>
                        <input type="number" id="med-duration" placeholder="e.g., 7" min="1" required>
                        <span id="duration-unit">days</span>
                    </div>
                    <div id="time-inputs">
                        <div class="time-input-container">
                            <input type="time" class="med-time" required>
                        </div>
                    </div>
                    <button type="button" class="add-time-btn" id="add-time-btn">+</button>
                    <p class="error-message" id="medication-form-error"></p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button type="submit" class="btn">Save</button>
                        <button type="button" class="btn" id="cancel-medication-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, getDoc, doc, saveMedicationToFirebase, saveVitalsToFirebase, deleteMedicationFromFirebase, collection, query, where, onSnapshot, setDoc } from './firebase.js';

        document.addEventListener("DOMContentLoaded", () => {
            let userPhone = null;
            let userId = null;
            let lastVitalsReminderDate = null;

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userId = user.uid;
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            userPhone = userDoc.data().phoneNumber;
                        }
                    } catch (error) {
                        // Handle error silently
                    }
                    setupRealtimeListeners();
                } else {
                    window.location.href = "login.html";
                }
            });

            gsap.from(".header", { duration: 1, y: -50, opacity: 0, ease: "power2.out" });
            gsap.from(".container", { duration: 1, y: 50, opacity: 0, ease: "power2.out", delay: 0.2 });

            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    document.querySelector(`.nav a[data-page="${pageId}"]`).classList.add('active');
                    gsap.from(`#${pageId}`, { duration: 0.5, opacity: 0, y: 20 });
                    if (pageId === "insights-page") {
                        analyzeVitals();
                    }
                }
            }

            document.querySelectorAll('.nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    showPage(pageId);
                });
            });

            document.getElementById("logout-btn").addEventListener("click", () => {
                auth.signOut().then(() => {
                    window.location.href = "index.html";
                }).catch(() => {});
            });

            let medications = [];
            function setupRealtimeListeners() {
                const medQuery = query(collection(db, "medications"), where("userId", "==", userId));
                onSnapshot(medQuery, (snapshot) => {
                    medications = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.times = Array.isArray(data.times) ? data.times : [];
                        medications.push({ 
                            id: doc.id, 
                            ...data, 
                            status: data.status || "upcoming", 
                            progress: data.progress || 0, 
                            lastChecked: data.lastChecked || null,
                            duration: data.duration || null,
                            endDate: data.endDate || null,
                            missedDoses: data.missedDoses || 0,
                            lastReminder: data.lastReminder || null,
                            completedDoses: data.completedDoses || []
                        });
                    });
                    updateMedicationList();
                    checkMissedMedications();
                }, () => {});

                const vitalsQuery = query(collection(db, "vitals"), where("userId", "==", userId));
                onSnapshot(vitalsQuery, (snapshot) => {
                    vitalsData = [];
                    snapshot.forEach(doc => vitalsData.push(doc.data()));
                    updateVitalsChart();
                    analyzeVitals();
                }, () => {});
            }

            function showAddMedicationModal() {
                document.getElementById("add-medication-modal").style.display = "flex";
                document.getElementById("medication-form-error").style.display = "none";
                updateDurationLabel();
                gsap.from(".modal-content", { duration: 0.5, scale: 0.8, opacity: 0 });
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = "none";
                document.getElementById("time-inputs").innerHTML = `
                    <div class="time-input-container">
                        <input type="time" class="med-time" required>
                    </div>
                `;
                document.getElementById("medication-form").reset();
                document.getElementById("medication-form-error").style.display = "none";
                updateDurationLabel();
            }

            function updateDurationLabel() {
                const frequency = document.getElementById("med-frequency").value;
                document.getElementById("duration-unit").textContent = frequency === "daily" ? "days" : "weeks";
            }

            document.getElementById("add-medication-btn").addEventListener("click", showAddMedicationModal);
            document.getElementById("cancel-medication-btn").addEventListener("click", () => closeModal("add-medication-modal"));
            document.getElementById("med-frequency").addEventListener("change", updateDurationLabel);

            document.getElementById("add-time-btn").addEventListener("click", () => {
                const timeInputs = document.getElementById("time-inputs");
                const newTimeInput = document.createElement("div");
                newTimeInput.className = "time-input-container";
                newTimeInput.innerHTML = `<input type="time" class="med-time" required>`;
                timeInputs.appendChild(newTimeInput);
                gsap.from(newTimeInput, { duration: 0.5, x: -20, opacity: 0 });
            });

            document.getElementById("medication-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const errorMessage = document.getElementById("medication-form-error");
                errorMessage.style.display = "none";
                const timeInputs = document.querySelectorAll(".med-time");
                const times = Array.from(timeInputs).map(input => input.value).filter(time => time);
                const duration = Number(document.getElementById("med-duration").value);
                if (times.length === 0) {
                    errorMessage.textContent = "Please add at least one valid time.";
                    errorMessage.style.display = "block";
                    return;
                }
                if (isNaN(duration) || duration < 1) {
                    errorMessage.textContent = "Please enter a valid duration (≥1).";
                    errorMessage.style.display = "block";
                    return;
                }
                const frequency = document.getElementById("med-frequency").value;
                const endDate = new Date();
                if (frequency === "daily") {
                    endDate.setDate(endDate.getDate() + duration);
                } else {
                    endDate.setDate(endDate.getDate() + duration * 7);
                }
                const med = {
                    name: document.getElementById("med-name").value,
                    dosage: document.getElementById("med-dosage").value,
                    frequency: frequency,
                    times: times,
                    status: "upcoming",
                    progress: 0,
                    lastChecked: null,
                    duration: duration,
                    createdAt: new Date().toISOString(),
                    endDate: endDate.toISOString(),
                    missedDoses: 0,
                    lastReminder: null,
                    completedDoses: []
                };
                try {
                    await saveMedicationToFirebase(med);
                    closeModal("add-medication-modal");
                    document.getElementById("medication-form").reset();
                } catch (error) {
                    errorMessage.textContent = error.message.includes("No authenticated user") ? 
                        "Please log in again to save medications." : 
                        error.message.includes("permission-denied") ? 
                        "Permission denied. Please ensure you are logged in with the correct account." : 
                        `Failed to save medication: ${error.message}`;
                    errorMessage.style.display = "block";
                }
            });

            function updateMedicationList() {
                const list = document.getElementById("medication-list");
                const errorMessage = document.getElementById("medication-error");
                list.innerHTML = "";
                errorMessage.style.display = "none";
                const now = new Date();
                let validMedications = 0;
                medications.forEach((med, index) => {
                    if (!Array.isArray(med.times) || med.times.length === 0 || !med.times.every(time => typeof time === 'string')) {
                        const div = document.createElement("div");
                        div.className = "medication-container";
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>⚠️ ${med.name} - Invalid times data</span>
                                <div>
                                    <button class="btn delete-btn" style="padding: 8px 16px;" data-id="${med.id}">Delete</button>
                                </div>
                            </div>
                        `;
                        list.appendChild(div);
                        return;
                    }
                    validMedications++;
                    const statusIcon = med.status === "completed" ? "✅" : med.status === "not taken" ? "❌" : "⏳";
                    const nextTime = getNextMedicationTime(med);
                    const isTimeToTake = isWithinTimeWindow(med, now);
                    const timesDisplay = med.times.join(", ");
                    let remainingText = "";
                    if (med.endDate) {
                        const startDate = new Date(med.createdAt || now);
                        const endDate = new Date(med.endDate);
                        const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
                        const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                        const daysRemaining = Math.max(0, totalDuration - daysPassed);
                        const unit = med.frequency === "daily" ? "days" : "weeks";
                        if (daysRemaining <= 0 && med.status !== "completed") {
                            med.status = "completed";
                            med.progress = 100;
                            setDoc(doc(db, "medications", med.id), med).catch(() => {});
                        }
                        remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "completed";
                    }
                    const div = document.createElement("div");
                    div.className = "medication-container";
                    div.innerHTML = `
                        <table class="medication-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Dosage</th>
                                    <th>Frequency</th>
                                    <th>Times</th>
                                    <th>Status</th>
                                    <th>Remaining</th>
                                    <th>Missed Doses</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${med.name}</td>
                                    <td>${med.dosage}</td>
                                    <td>${med.frequency}</td>
                                    <td>${timesDisplay}${isTimeToTake ? "" : `, next: ${nextTime || 'N/A'}`}</td>
                                    <td>${statusIcon} ${med.status}</td>
                                    <td>${remainingText}</td>
                                    <td class="missed-dose">${med.missedDoses || 0}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 10px;">
                            ${isTimeToTake ? `<button class="btn mark-done-btn" style="padding: 8px 16px;" data-index="${index}" data-id="${med.id}">Mark Done</button>` : ''}
                            <button class="btn delete-btn" style="padding: 8px 16px;" data-id="${med.id}">Delete</button>
                        </div>
                        <div class="progress-bar"><div class="progress" style="width: ${med.progress}%"></div></div>
                    `;
                    list.appendChild(div);
                    gsap.from(div, { duration: 0.5, x: -20, opacity: 0, delay: index * 0.1 });
                });
                if (medications.length === 0) {
                    list.innerHTML = `<p>No medications found. Add a new medication using the "+" button.</p>`;
                } else if (validMedications === 0 && medications.length > 0) {
                    errorMessage.textContent = "No valid medications found. Please delete invalid entries or add new medications.";
                    errorMessage.style.display = "block";
                }

                document.querySelectorAll(".mark-done-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const index = parseInt(btn.getAttribute("data-index"));
                        markCompleted(index);
                    });
                });

                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const docId = btn.getAttribute("data-id");
                        try {
                            await deleteMedicationFromFirebase(docId);
                        } catch (error) {
                            errorMessage.textContent = `Failed to delete medication: ${error.message}`;
                            errorMessage.style.display = "block";
                        }
                    });
                });
            }

            function getNextMedicationTime(med) {
                if (!Array.isArray(med.times) || med.times.length === 0) {
                    return null;
                }
                const now = new Date();
                let nextTime = null;
                med.times.forEach(time => {
                    if (typeof time !== 'string') return;
                    try {
                        const [hours, minutes] = time.split(":").map(Number);
                        if (isNaN(hours) || isNaN(minutes)) return;
                        const medTime = new Date();
                        medTime.setHours(hours, minutes, 0, 0);
                        if (medTime > now && (!nextTime || medTime < nextTime)) {
                            nextTime = medTime;
                        }
                    } catch (error) {}
                });
                if (!nextTime && med.frequency === "daily") {
                    const firstTime = med.times.find(time => typeof time === 'string');
                    if (firstTime) {
                        try {
                            const [hours, minutes] = firstTime.split(":").map(Number);
                            if (!isNaN(hours) && !isNaN(minutes)) {
                                nextTime = new Date();
                                nextTime.setDate(nextTime.getDate() + 1);
                                nextTime.setHours(hours, minutes, 0, 0);
                            }
                        } catch (error) {}
                    }
                }
                return nextTime ? nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : null;
            }

            function isWithinTimeWindow(med, now) {
                if (!Array.isArray(med.times) || med.times.length === 0) {
                    return false;
                }
                return med.times.some(time => {
                    if (typeof time !== 'string') return false;
                    try {
                        const [hours, minutes] = time.split(":").map(Number);
                        if (isNaN(hours) || isNaN(minutes)) return false;
                        const medTime = new Date();
                        medTime.setHours(hours, minutes, 0, 0);
                        const windowStart = new Date(medTime.getTime() - 30 * 60 * 1000);
                        const windowEnd = new Date(medTime.getTime() + 30 * 60 * 1000);
                        return now >= windowStart && now <= windowEnd && med.status === "upcoming";
                    } catch (error) {
                        return false;
                    }
                });
            }

            async function markCompleted(index) {
                const med = medications[index];
                if (!med) return;
                const now = new Date();
                med.completedDoses = med.completedDoses || [];
                med.completedDoses.push(now.toISOString());
                med.lastChecked = now.toISOString();
                const totalDoses = calculateTotalDoses(med);
                med.progress = totalDoses > 0 ? (med.completedDoses.length / totalDoses * 100) : 0;
                med.status = med.progress >= 100 ? "completed" : "upcoming";
                try {
                    await setDoc(doc(db, "medications", med.id), med);
                } catch (error) {
                    const errorMessage = document.getElementById("medication-error");
                    errorMessage.textContent = `Failed to update medication status: ${error.message}`;
                    errorMessage.style.display = "block";
                }
            }

            function calculateTotalDoses(med) {
                if (!med.createdAt || !med.endDate || !med.times) return 0;
                const startDate = new Date(med.createdAt);
                const endDate = new Date(med.endDate);
                const now = new Date();
                const effectiveEndDate = now < endDate ? now : endDate;
                const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                return med.frequency === "daily" ? days * med.times.length : Math.floor(days / 7) * med.times.length;
            }

            async function checkMedicationReminders() {
                const now = new Date();
                for (const med of medications) {
                    if (med.status === "completed" || !med.times || !Array.isArray(med.times) || med.times.length === 0) continue;
                    for (const time of med.times) {
                        if (typeof time !== 'string') continue;
                        try {
                            const [hours, minutes] = time.split(":").map(Number);
                            if (isNaN(hours) || isNaN(minutes)) continue;
                            const medTime = new Date();
                            medTime.setHours(hours, minutes, 0, 0);
                            const reminderTime = new Date(medTime.getTime() - 5 * 60 * 1000);
                            const windowStart = new Date(reminderTime.getTime() - 30 * 1000);
                            const windowEnd = new Date(reminderTime.getTime() + 30 * 1000);
                            const lastReminder = med.lastReminder ? new Date(med.lastReminder) : null;
                            const reminderCooldown = 5 * 60 * 1000;
                            if (now >= windowStart && now <= windowEnd && (!lastReminder || (now - lastReminder) > reminderCooldown)) {
                                const message = `Time to take ${med.name} (${med.dosage}) at ${time}. Reply 'Yes' to confirm, 'No' to skip.`;
                                await sendSMS(message);
                                med.lastReminder = now.toISOString();
                                await setDoc(doc(db, "medications", med.id), med).catch(() => {});
                            }
                        } catch (error) {}
                    }
                }
            }

            async function checkMissedMedications() {
                const now = new Date();
                for (const med of medications) {
                    if (med.status === "completed" || !Array.isArray(med.times) || med.times.length === 0) continue;
                    let updated = false;
                    let missedDoses = 0;
                    const startDate = new Date(med.createdAt || now);
                    const endDate = new Date(med.endDate);
                    const effectiveEndDate = now < endDate ? now : endDate;
                    const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                    for (let day = 0; day < days; day++) {
                        if (med.frequency === "weekly" && day % 7 !== 0) continue;
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + day);
                        for (const time of med.times) {
                            if (typeof time !== 'string') continue;
                            try {
                                const [hours, minutes] = time.split(":").map(Number);
                                if (isNaN(hours) || isNaN(minutes)) continue;
                                const doseTime = new Date(currentDate);
                                doseTime.setHours(hours, minutes, 0, 0);
                                const missedWindow = new Date(doseTime.getTime() + 4 * 60 * 60 * 1000);
                                if (now <= missedWindow || doseTime > now) continue;

                                const completed = med.completedDoses && med.completedDoses.some(completedTime => {
                                    const completedDate = new Date(completedTime);
                                    const windowStart = new Date(doseTime.getTime() - 30 * 60 * 1000);
                                    const windowEnd = new Date(doseTime.getTime() + 30 * 60 * 1000);
                                    return completedDate >= windowStart && completedDate <= windowEnd;
                                });

                                if (!completed) {
                                    missedDoses++;
                                    const lastReminder = med.lastReminder ? new Date(med.lastReminder) : null;
                                    const reminderCooldown = 5 * 60 * 1000;
                                    if (!lastReminder || (now - lastReminder) > reminderCooldown) {
                                        const message = `Missed dose: ${med.name} at ${time} on ${doseTime.toLocaleDateString()}. Total missed: ${missedDoses}. Reply 'Yes' to confirm taking now, or 'No' to skip.`;
                                        await sendSMS(message);
                                        med.lastReminder = now.toISOString();
                                        await setDoc(doc(db, "medications", med.id), { ...med, lastReminder: now.toISOString() }).catch(() => {});
                                    }
                                    updated = true;
                                }
                            } catch (error) {}
                        }
                    }

                    if (med.missedDoses !== missedDoses) {
                        med.missedDoses = missedDoses;
                        med.status = "not taken";
                        updated = true;
                    }

                    if (updated) {
                        try {
                            await setDoc(doc(db, "medications", med.id), med);
                        } catch (error) {
                            const errorMessage = document.getElementById("medication-error");
                            errorMessage.textContent = `Failed to update medication status: ${error.message}`;
                            errorMessage.style.display = "block";
                        }
                    }
                }
                updateMedicationList();
            }

            let vitalsData = [];
            const ctx = document.getElementById("vitals-chart").getContext("2d");
            const vitalsChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        { label: "Systolic BP", data: [], borderColor: "#4CB5AB", fill: false },
                        { label: "Diastolic BP", data: [], borderColor: "#FF8566", fill: false },
                        { label: "Blood Sugar", data: [], borderColor: "#333A40", fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            document.getElementById("vitals-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const inputs = [
                    { id: "bp-systolic", value: Number(document.getElementById("bp-systolic").value) },
                    { id: "bp-diastolic", value: Number(document.getElementById("bp-diastolic").value) },
                    { id: "sugar", value: Number(document.getElementById("sugar").value) },
                    { id: "heart-rate", value: Number(document.getElementById("heart-rate").value) },
                    { id: "weight", value: Number(document.getElementById("weight").value) },
                    { id: "temp", value: Number(document.getElementById("temp").value) }
                ];
                let isValid = true;
                inputs.forEach(input => {
                    const errorElement = document.getElementById(`${input.id}-error`);
                    if (input.value < 0 || isNaN(input.value)) {
                        errorElement.style.display = "block";
                        isValid = false;
                    } else {
                        errorElement.style.display = "none";
                    }
                });
                if (!isValid) return;
                const vitals = {
                    systolic: inputs[0].value,
                    diastolic: inputs[1].value,
                    sugar: inputs[2].value,
                    heartRate: inputs[3].value,
                    weight: inputs[4].value,
                    temp: inputs[5].value,
                    timestamp: new Date().toISOString()
                };
                try {
                    await saveVitalsToFirebase(vitals);
                    document.getElementById("vitals-form").reset();
                    gsap.from(".vitals-form", { duration: 0.5, scale: 0.95, opacity: 0 });
                } catch (error) {
                    alert("Failed to save vitals: " + error.message);
                }
            });

            function updateVitalsChart() {
                vitalsChart.data.labels = vitalsData.map(v => new Date(v.timestamp).toLocaleDateString());
                vitalsChart.data.datasets[0].data = vitalsData.map(v => v.systolic);
                vitalsChart.data.datasets[1].data = vitalsData.map(v => v.diastolic);
                vitalsChart.data.datasets[2].data = vitalsData.map(v => v.sugar);
                vitalsChart.update();
                gsap.from("#vitals-chart", { duration: 1, opacity: 0, scale: 0.95 });
            }

            async function analyzeVitals() {
                const insights = document.getElementById("insights-content");
                insights.innerHTML = "";
                if (vitalsData.length === 0 && medications.length === 0) {
                    insights.innerHTML = "<p>No vitals or medication data available. Please log vitals or add medications to receive insights.</p>";
                    return;
                }
                insights.innerHTML = `
                    <h3>Health Summary</h3>
                    <p>The following insights are based on your recent vitals and medication adherence data as of ${new Date().toLocaleDateString()}.</p>
                `;
                if (medications.length > 0) {
                    const completedMeds = medications.filter(m => m.status === "completed").length;
                    const totalMissedDoses = medications.reduce((sum, m) => sum + (m.missedDoses || 0), 0);
                    const totalDoses = medications.reduce((sum, m) => sum + calculateTotalDoses(m), 0);
                    const completedDoses = medications.reduce((sum, m) => sum + (m.completedDoses ? m.completedDoses.length : 0), 0);
                    const adherenceRate = totalDoses > 0 ? (completedDoses / totalDoses * 100).toFixed(1) : 0;
                    const overdueMeds = medications.filter(m => m.endDate && new Date(m.endDate) < new Date() && m.status !== "completed");
                    insights.innerHTML += `
                        <h4>Medication Adherence</h4>
                        <p><strong>Adherence Rate:</strong> ${adherenceRate}% (${completedDoses} of ${totalDoses} doses marked as completed).</p>
                        <p><strong>Total Missed Doses:</strong> ${totalMissedDoses}</p>
                        ${adherenceRate < 80 ? "<p style='color: #FF8566;'>⚠️ Your adherence rate is below 80%. Consistent medication intake is crucial for effective treatment. Consider setting reminders or consulting your healthcare provider.</p>" : "<p style='color: #4CB5AB;'>✅ Excellent adherence! Keep up the consistent medication schedule.</p>"}
                        ${overdueMeds.length > 0 ? `<p style='color: #FF8566;'>⚠️ Overdue Medications: ${overdueMeds.map(m => m.name).join(", ")}. These medications have passed their duration. Please review with your doctor.</p>` : ""}
                    `;
                    if (overdueMeds.length > 0) {
                        const message = `Overdue: ${overdueMeds.map(m => m.name).join(", ")} duration ended on ${new Date(overdueMeds[0].endDate).toLocaleDateString()}. Consult your doctor.`;
                        await sendSMS(message);
                    }
                }
                if (vitalsData.length > 0) {
                    const recentVitals = vitalsData.slice(-5);
                    const avgSystolic = recentVitals.reduce((sum, v) => sum + v.systolic, 0) / recentVitals.length;
                    const avgDiastolic = recentVitals.reduce((sum, v) => sum + v.diastolic, 0) / recentVitals.length;
                    const avgSugar = recentVitals.reduce((sum, v) => sum + v.sugar, 0) / recentVitals.length;
                    const highBPCount = vitalsData.filter(v => v.systolic > 140 || v.diastolic > 90).length;
                    const highSugarCount = vitalsData.filter(v => v.sugar > 180).length;
                    insights.innerHTML += `
                        <h4>Vital Signs Analysis</h4>
                        <p><strong>Average Blood Pressure (last ${recentVitals.length} entries):</strong> ${avgSystolic.toFixed(1)}/${avgDiastolic.toFixed(1)} mmHg</p>
                        <p><strong>Average Blood Sugar:</strong> ${avgSugar.toFixed(1)} mg/dL</p>
                        ${highBPCount >= 3 ? "<p style='color: #FF8566;'>⚠️ High blood pressure detected in 3 or more readings. Reduce salt intake, manage stress, and consult a healthcare provider.</p>" : "<p style='color: #4CB5AB;'>✅ Blood pressure is within normal range.</p>"}
                        ${highSugarCount > 0 ? "<p style='color: #FF8566;'>🚨 High blood sugar detected in recent readings. Avoid sugary foods, monitor diet, and consult a doctor.</p>" : "<p style='color: #4CB5AB;'>✅ Blood sugar levels are stable.</p>"}
                    `;
                    if (highBPCount >= 3 || highSugarCount > 0) {
                        await sendSMS("Health alert: Abnormal vitals detected. Please review your recent blood pressure or sugar readings and consult a doctor.");
                    }
                }
                insights.innerHTML += `
                    <h4>Recommendations</h4>
                    <ul style="text-align: left;">
                        <li>Log vitals daily to monitor trends effectively.</li>
                        <li>Ensure timely medication intake to maintain adherence above 80%.</li>
                        <li>Schedule a consultation with your healthcare provider if you notice persistent abnormal vitals or missed doses.</li>
                        <li>Maintain a balanced diet and regular physical activity to support overall health.</li>
                    </ul>
                `;
                gsap.from(insights, { duration: 0.5, y: 20, opacity: 0 });
            }

            function exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("helvetica", "bold");
                doc.text("Medisync Family Health Report", 10, 10);
                doc.setFont("helvetica", "normal");
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 10, 20);
                doc.text("Vitals Log:", 10, 30);
                let yPos = 40;
                const vitalsTableData = vitalsData.map(v => [
                    new Date(v.timestamp).toLocaleString(),
                    v.systolic.toString(),
                    v.diastolic.toString(),
                    v.sugar.toString(),
                    v.heartRate.toString(),
                    v.weight.toString(),
                    v.temp.toString()
                ]);
                doc.autoTable({
                    startY: yPos,
                    head: [['Date', 'Systolic BP (mmHg)', 'Diastolic BP (mmHg)', 'Blood Sugar (mg/dL)', 'Heart Rate (bpm)', 'Weight (kg)', 'Temperature (°C)']],
                    body: vitalsTableData,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
                    headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[1]) > 140) ? [231, 76, 60] : [51, 58, 64] },
                        2: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[2]) > 90) ? [231, 76, 60] : [51, 58, 64] },
                        3: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[3]) > 180) ? [231, 76, 60] : [51, 58, 64] },
                        4: { cellWidth: 25, halign: 'center' },
                        5: { cellWidth: 25, halign: 'center' },
                        6: { cellWidth: 25, halign: 'center' }
                    },
                    margin: { left: 10, right: 10 }
                });
                yPos = doc.lastAutoTable.finalY + 10;
                doc.text("Medications:", 10, yPos);
                yPos += 10;
                const tableData = medications.map(med => {
                    const timesDisplay = Array.isArray(med.times) && med.times.length > 0 && med.times.every(time => typeof time === 'string') ? med.times.join(", ") : "No valid times";
                    const startDate = new Date(med.createdAt || new Date());
                    const endDate = new Date(med.endDate);
                    const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
                    const daysPassed = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));
                    const daysRemaining = Math.max(0, totalDuration - daysPassed);
                    const unit = med.frequency === "daily" ? "days" : "weeks";
                    const remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "completed";
                    const statusIcon = med.status === "completed" ? "✅" : med.status === "not taken" ? "❌" : "⏳";
                    return [
                        med.name,
                        med.dosage,
                        med.frequency,
                        timesDisplay,
                        `${statusIcon} ${med.status}`,
                        remainingText,
                        med.missedDoses || 0
                    ];
                });
                doc.autoTable({
                    startY: yPos,
                    head: [['Name', 'Dosage', 'Frequency', 'Times', 'Status', 'Remaining', 'Missed Doses']],
                    body: tableData,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
                    headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 40 },
                        4: { cellWidth: 25, halign: 'center' },
                        5: { cellWidth: 30 },
                        6: { cellWidth: 20, halign: 'center', textColor: tableData.some(row => row[6] > 0) ? [231, 76, 60] : [51, 58, 64] }
                    },
                    margin: { left: 10, right: 10 }
                });
                doc.save("Medisync_Health_Report.pdf");
            }

            document.getElementById("export-pdf-btn").addEventListener("click", exportToPDF);

            async function sendSMS(message) {
                if (!userPhone || !/^\+\d{10,15}$/.test(userPhone)) return;
                try {
                    const response = await fetch('https://medisync-backend-1-o8mt.onrender.com/send-sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer my-unique-token-123'
                        },
                        body: JSON.stringify({ to: userPhone, body: message })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    await response.json();
                } catch (error) {}
            }

            setInterval(async () => {
                const now = new Date();
                await checkMedicationReminders();
                await checkMissedMedications();
                if (now.getDate() % 14 === 0 && now.getHours() === 8 && now.getMinutes() === 0) {
                    if (!lastVitalsReminderDate || (now - new Date(lastVitalsReminderDate)) > 24 * 60 * 60 * 1000) {
                        await sendSMS("Hey! It’s time to update your vitals on Medisync Family for your health check-in.");
                        lastVitalsReminderDate = now.toISOString();
                    }
                }
            }, 60 * 1000);
        });
    </script>
</body>
</html>
