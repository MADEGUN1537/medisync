<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’ŠMedisync: Medication Reminder & Health Tracker</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #4CB5AB;
            --accent: #FF8566;
            --background: #F7F9FA;
            --text: #333A40;
            --gradient: linear-gradient(135deg, #4CB5AB, #66d9cc);
            --error: #e74c3c;
            --success: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Open Sans', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }

        .header {
            background: var(--gradient);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nav a {
            color: var(--text);
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1.1em;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s ease, color 0.3s ease;
            cursor: pointer;
        }

        .nav a:hover {
            background: var(--primary);
            color: white;
        }

        .nav a.active {
            background: var(--primary);
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .medication-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .medication-card.active {
            font-weight: bold;
        }

        .medication-card.inactive {
            opacity: 0.6;
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .medication-header h4 {
            font-size: 1.3em;
            color: var(--text);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .status-upcoming {
            background: #3498db;
            color: white;
        }

        .status-completed {
            background: var(--success);
            color: white;
        }

        .status-not-taken {
            background: var(--error);
            color: white;
        }

        .medication-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .medication-details p {
            margin: 5px 0;
        }

        .medication-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--gradient);
            transition: width 0.5s ease;
        }

        .add-btn {
            background: var(--accent);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            position: fixed;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .btn {
            background: var(--gradient);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .delete-btn {
            background: var(--error);
        }

        .mark-done-btn {
            background: var(--success);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 2000;
        }

        .toast.error {
            background: var(--error);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background: var(--text);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .vitals-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .vitals-form label {
            display: block;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .vitals-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .vitals-form input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(76, 181, 171, 0.3);
            outline: none;
        }

        .vitals-form .full-width {
            grid-column: span 2;
        }

        .vitals-form .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            padding: 8px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .profile-form label {
            display: block;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .profile-form input,
        .profile-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .profile-form select {
            width: 100px;
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23333" d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
            background-size: 12px;
        }

        .profile-form input:focus,
        .profile-form select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(76, 181, 171, 0.3);
            outline: none;
        }

        .profile-form .full-width {
            grid-column: span 2;
        }

        .profile-form .field-group {
            display: none;
        }

        .profile-form .field-group.active {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .profile-form .full-width.field-group.active {
            grid-template-columns: 1fr;
        }

        .profile-form .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .profile-form .error-message {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            padding: 8px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        .time-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-input-container input {
            flex-grow: 1;
        }

        .add-time-btn {
            background: var(--accent);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .add-time-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .duration-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .duration-container label {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--text);
        }

        .profile-details {
            margin-bottom: 20px;
        }

        .profile-details p {
            font-size: 1em;
            margin: 10px 0;
        }

        .profile-details button {
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
        }

        .profile-details button:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .nav a {
                padding: 8px 15px;
            }

            .add-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .vitals-form, .profile-form {
                grid-template-columns: 1fr;
            }

            .vitals-form .full-width, .profile-form .full-width {
                grid-column: span 1;
            }

            .medication-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ðŸ’ŠMedisync</h1>
            <p style="font-size: 1em; opacity: 0.9;">Your Health, Our Priority</p>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
    <div class="container">
        <div class="nav">
            <a href="#medications" data-page="medications-page" class="active">Medications</a>
            <a href="#vitals" data-page="vitals-page">Vitals</a>
            <a href="#insights" data-page="insights-page">Insights</a>
            <a href="#profile" data-page="profile-page">Profile</a>
        </div>

        <div id="medications-page" class="page active">
            <div class="card" id="medication-tracker">
                <h2>Medication Tracker</h2>
                <div id="medication-list"></div>
                <p class="error-message" id="medication-error"></p>
            </div>
            <div class="add-btn" id="add-medication-btn">+</div>
        </div>

        <div id="vitals-page" class="page">
            <div class="card" id="vitals-tracker">
                <h2>Vital Signs</h2>
                <div class="tooltip">
                    <span>What's normal BP?</span>
                    <span class="tooltiptext">Normal BP is typically 120/80 mmHg.</span>
                </div>
                <form id="vitals-form" class="vitals-form">
                    <div>
                        <label for="bp-systolic">Systolic BP (mmHg)</label>
                        <input type="number" id="bp-systolic" placeholder="e.g., 120" min="0" required>
                        <p class="error-message" id="bp-systolic-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <div>
                        <label for="bp-diastolic">Diastolic BP (mmHg)</label>
                        <input type="number" id="bp-diastolic" placeholder="e.g., 80" min="0" required>
                        <p class="error-message" id="bp-diastolic-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <div>
                        <label for="sugar">Blood Sugar (mg/dL)</label>
                        <input type="number" id="sugar" placeholder="e.g., 100" min="0" required>
                        <p class="error-message" id="sugar-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <div>
                        <label for="heart-rate">Heart Rate (bpm)</label>
                        <input type="number" id="heart-rate" placeholder="e.g., 70" min="0" required>
                        <p class="error-message" id="heart-rate-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <div>
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="e.g., 70" min="0" step="0.1" required>
                        <p class="error-message" id="weight-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <div>
                        <label for="temp">Temperature (Â°C)</label>
                        <input type="number" id="temp" placeholder="e.g., 36.6" min="0" step="0.1" required>
                        <p class="error-message" id="temp-error">Please enter a valid number (â‰¥0).</p>
                    </div>
                    <button type="submit" class="btn full-width">Log Vitals</button>
                </form>
                <canvas id="vitals-chart" style="margin-top: 20px;"></canvas>
            </div>
        </div>

        <div id="insights-page" class="page">
            <div class="card" id="insights">
                <h2>Health Insights</h2>
                <div id="insights-content"></div>
            </div>
            <button class="btn" id="export-pdf-btn">Export Health Report</button>
        </div>

        <div id="profile-page" class="page">
            <div class="card" id="profile">
                <h2>User Profile</h2>
                <div class="profile-details" id="profile-details"></div>
                <form id="profile-form" class="profile-form" style="display: none;" data-field="">
                    <div id="name-field" class="field-group" style="display: none;">
                        <div>
                            <label for="first-name">First Name</label>
                            <input type="text" id="first-name" name="first-name" placeholder="e.g., John" required>
                            <p class="error-message" id="first-name-error">Please enter a valid first name.</p>
                        </div>
                        <div>
                            <label for="last-name">Last Name</label>
                            <input type="text" id="last-name" name="last-name" placeholder="e.g., Doe" required>
                            <p class="error-message" id="last-name-error">Please enter a valid last name.</p>
                        </div>
                    </div>
                    <div id="email-field" class="field-group" style="display: none;">
                        <div class="full-width">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="e.g., john@example.com" required>
                            <p class="error-message" id="email-error">Please enter a valid email address.</p>
                        </div>
                    </div>
                    <div id="phone-field" class="field-group" style="display: none;">
                        <div class="full-width">
                            <label for="phone-number">Phone Number</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="country-code" name="country-code">
                                    <option value="+234">+234 (NG)</option>
                                    <option value="+1">+1 (US)</option>
                                    <option value="+44">+44 (UK)</option>
                                    <option value="+91">+91 (IN)</option>
                                </select>
                                <input type="tel" id="phone-number" name="phone-number" placeholder="7034202953" required>
                            </div>
                            <p class="error-message" id="phone-number-error">Please enter a valid phone number (e.g., +2347034202953).</p>
                        </div>
                    </div>
                    <div id="password-field" class="field-group" style="display: none;">
                        <div>
                            <label for="password">New Password</label>
                            <input type="password" id="password" name="password" placeholder="Enter new password" required>
                            <p class="error-message" id="password-error">Password must be at least 6 characters.</p>
                        </div>
                        <div>
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm new password" required>
                            <p class="error-message" id="confirm-password-error">Passwords do not match.</p>
                        </div>
                    </div>
                    <div class="full-width button-group">
                        <button type="submit" class="btn">Save Changes</button>
                        <button type="button" class="btn" id="cancel-profile-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="add-medication-modal">
            <div class="modal-content">
                <h2>Add Medication</h2>
                <form id="medication-form">
                    <input type="text" id="med-name" placeholder="Medication Name" required>
                    <input type="text" id="med-dosage" placeholder="Dosage (e.g., 500mg)" required>
                    <select id="med-frequency" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                    <div class="duration-container">
                        <label id="duration-label">Duration</label>
                        <input type="number" id="med-duration" placeholder="e.g., 7" min="1" required>
                        <span id="duration-unit">days</span>
                    </div>
                    <div id="time-inputs">
                        <div class="time-input-container">
                            <input type="time" class="med-time" required>
                        </div>
                    </div>
                    <button type="button" class="add-time-btn" id="add-time-btn">+</button>
                    <p class="error-message" id="medication-form-error"></p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button type="submit" class="btn">Save</button>
                        <button type="button" class="btn" id="cancel-medication-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="toast" id="action-toast"></div>
    </div>

    <script type="module">
import { auth, db, getDoc, doc, saveMedicationToFirebase, saveVitalsToFirebase, deleteMedicationFromFirebase, collection, query, where, onSnapshot, setDoc, updatePassword, limit } from './firebase.js';

document.addEventListener("DOMContentLoaded", () => {
    let userPhone = null;
    let userId = null;
    let lastVitalsReminderDate = null;
    let userProfile = { firstName: '', lastName: '', email: '', phoneNumber: '' };
    let offlineReminders = JSON.parse(localStorage.getItem('offlineReminders')) || [];

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userId = user.uid;
            try {
                console.log('Attempting to fetch user profile for userId:', userId);
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    userPhone = userProfile.phoneNumber;
                    console.log('User profile loaded:', userProfile);
                    updateProfileDisplay();
                } else {
                    console.warn('User profile not found, creating default profile');
                    userProfile = { firstName: 'Unknown', lastName: '', email: user.email, phoneNumber: '' };
                    await setDoc(doc(db, "users", userId), userProfile);
                    updateProfileDisplay();
                    showToast('User profile not found. Created a default profile.', true);
                }
                setupRealtimeListeners();
                scheduleOfflineReminders();
            } catch (error) {
                console.error('Error fetching user profile:', error.code, error.message, error.stack);
                if (error.code === 'unavailable') {
                    showToast('You are offline. Using default profile.', true);
                    userProfile = { firstName: 'Offline', lastName: 'User', email: user.email, phoneNumber: '' };
                    updateProfileDisplay();
                } else {
                    showToast('Failed to load profile: ' + error.message, true);
                }
            }
        } else {
            console.log('No authenticated user, redirecting to login');
            window.location.href = 'login.html';
        }
    });

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            console.log('Service Worker registered:', reg);
        }).catch(err => {
            console.error('Service Worker registration failed:', err);
        });
    }

    gsap.from(".header", { duration: 1, y: -50, opacity: 0, ease: "power2.out" });
    gsap.from(".container", { duration: 1, y: 50, opacity: 0, ease: "power2.out", delay: 0.2 });

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            document.querySelector(`.nav a[data-page="${pageId}"]`).classList.add('active');
            gsap.from(`#${pageId}`, { duration: 0.5, opacity: 0, y: 20, ease: "power2.out" });
            if (pageId === "insights-page") {
                analyzeVitals();
            } else if (pageId === "profile-page") {
                updateProfileDisplay();
            }
        }
    }

    document.querySelectorAll('.nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = link.getAttribute('data-page');
            showPage(pageId);
        });
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
        auth.signOut().then(() => {
            window.location.href = "index.html";
        }).catch(() => {});
    });

    function showToast(message, isError = false) {
        const toast = document.getElementById("action-toast");
        toast.textContent = message;
        toast.className = `toast ${isError ? 'error' : ''}`;
        toast.style.display = "block";
        gsap.fromTo(toast, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" });
        setTimeout(() => {
            gsap.to(toast, { opacity: 0, y: 20, duration: 0.5, ease: "power2.in", onComplete: () => {
                toast.style.display = "none";
            }});
        }, 3000);
    }

    function updateProfileDisplay() {
        const profileDetails = document.getElementById("profile-details");
        const fullName = `${userProfile.firstName || 'Not set'} ${userProfile.lastName || ''}`.trim();
        profileDetails.innerHTML = `
            <p><strong>Full Name:</strong> ${fullName || 'Not set'} <button class="edit-profile-btn" data-field="name">Edit</button></p>
            <p><strong>Email:</strong> ${userProfile.email || 'Not set'} <button class="edit-profile-btn" data-field="email">Edit</button></p>
            <p><strong>Phone Number:</strong> <input type="text" id="phone-number-display" value="${userPhone || 'Not set'}" readonly> <button class="edit-profile-btn" data-field="phoneNumber">Change</button></p>
            <p><strong>Password:</strong> ******** <button class="edit-profile-btn" data-field="password">Change Password</button></p>
        `;
        document.querySelectorAll(".edit-profile-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const field = btn.getAttribute("data-field");
                showProfileEditForm(field);
            });
        });
        document.getElementById("profile-form").style.display = "none";
    }

    function showProfileEditForm(field) {
    if (!userId || !auth.currentUser) {
        showToast("User not authenticated. Please log in again.", true);
        window.location.href = 'login.html';
        return;
    }
    console.log('Attempting to show edit form for field:', field);
    const form = document.getElementById("profile-form");
    if (!form) {
        console.error('Profile form not found');
        return;
    }
    form.setAttribute("data-field", field);

    // Remove 'required' from all inputs to prevent validation errors
    const inputs = ["first-name", "last-name", "email", "phone-number", "password", "confirm-password"];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) input.removeAttribute("required");
    });

    const fields = ["name-field", "email-field", "phone-field", "password-field"];
    fields.forEach(f => {
        const fieldElement = document.getElementById(f);
        if (fieldElement) {
            // Map 'phoneNumber' field to 'phone-field' for display toggle
            const isActive = f === (field === "phoneNumber" ? "phone-field" : `${field}-field`);
            fieldElement.classList.toggle("active", isActive);
            fieldElement.style.display = isActive ? "grid" : "none";
            console.log(`Field ${f} display set to: ${fieldElement.style.display}`);
        } else {
            console.error(`Field element ${f} not found in DOM`);
        }
    });

    // Initialize inputs
    const firstNameInput = document.getElementById("first-name");
    const lastNameInput = document.getElementById("last-name");
    const emailInput = document.getElementById("email");
    const phoneInput = document.getElementById("phone-number");
    const countryCodeSelect = document.getElementById("country-code");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm-password");

    // Set 'required' and values only for active field inputs
    if (field === "name" && firstNameInput && lastNameInput) {
        firstNameInput.setAttribute("required", "");
        lastNameInput.setAttribute("required", "");
        firstNameInput.value = userProfile.firstName || '';
        lastNameInput.value = userProfile.lastName || '';
    } else if (field === "email" && emailInput) {
        emailInput.setAttribute("required", "");
        emailInput.value = userProfile.email || '';
    } else if (field === "phoneNumber" && phoneInput && countryCodeSelect) {
        if (!phoneInput || !countryCodeSelect) {
            console.error('Phone input or country code select not found:', { phoneInput, countryCodeSelect });
            showToast("Phone input field is missing in the form.", true);
            return;
        }
        phoneInput.setAttribute("required", "");
        phoneInput.value = userPhone ? userPhone.replace(/^\+\d{1,3}/, '') : '';
        countryCodeSelect.value = userPhone ? userPhone.match(/^\+\d{1,3}/)?.[0] || '+234' : '+234';
    } else if (field === "password" && passwordInput && confirmPasswordInput) {
        passwordInput.setAttribute("required", "");
        confirmPasswordInput.setAttribute("required", "");
        passwordInput.value = '';
        confirmPasswordInput.value = '';
    }

    // Update phone placeholder
    const updatePhonePlaceholder = () => {
        if (countryCodeSelect && phoneInput) {
            const countryCode = countryCodeSelect.value;
            phoneInput.placeholder = countryCode === '+234' ? '7034202953' :
                                    countryCode === '+1' ? '1234567890' :
                                    countryCode === '+44' ? '7912345678' :
                                    countryCode === '+91' ? '9876543210' : 'Enter phone number';
            console.log('Phone placeholder updated to:', phoneInput.placeholder);
        }
    };
    if (field === "phoneNumber" && phoneInput && countryCodeSelect) {
        updatePhonePlaceholder();
        countryCodeSelect.removeEventListener('change', updatePhonePlaceholder);
        countryCodeSelect.addEventListener('change', updatePhonePlaceholder);
    }

    // Focus only the active fieldâ€™s input if its container is visible
    if (field === "name" && firstNameInput && document.getElementById("name-field").style.display === "grid") {
        firstNameInput.focus();
        console.log('Focused on first name input');
    } else if (field === "email" && emailInput && document.getElementById("email-field").style.display === "grid") {
        emailInput.focus();
        console.log('Focused on email input');
    } else if (field === "phoneNumber" && phoneInput && document.getElementById("phone-field").style.display === "grid") {
        phoneInput.focus();
        console.log('Focused on phone number input');
        // Debug phone field visibility
        console.log('Phone field visibility:', document.getElementById("phone-field").offsetParent !== null);
        console.log('Phone input computed style:', window.getComputedStyle(phoneInput).display);
        console.log('Country code select computed style:', window.getComputedStyle(countryCodeSelect).display);
    } else if (field === "password" && passwordInput && document.getElementById("password-field").style.display === "grid") {
        passwordInput.focus();
        console.log('Focused on password input');
    } else {
        console.log('No focus applied; active field inputs may be hidden or unavailable');
    }

    form.style.display = "grid";
    document.querySelectorAll(".profile-form .error-message").forEach(error => error.style.display = "none");
    gsap.from(form, { duration: 0.5, scale: 0.95, opacity: 0, ease: "power2.out" });
}

    document.getElementById("profile-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!userId || !auth.currentUser) {
            showToast("User not authenticated. Please log in again.", true);
            window.location.href = 'login.html';
            return;
        }
        const field = document.getElementById("profile-form").getAttribute("data-field");
        console.log('Submitting form for field:', field);
        let isValid = true;
        const updateData = {};

        if (field === "name") {
            const firstName = document.getElementById("first-name").value.trim();
            const lastName = document.getElementById("last-name").value.trim();
            if (!/^[A-Za-z\s]+$/.test(firstName)) {
                document.getElementById("first-name-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("first-name-error").style.display = "none";
                updateData.firstName = firstName;
            }
            if (!/^[A-Za-z\s]+$/.test(lastName)) {
                document.getElementById("last-name-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("last-name-error").style.display = "none";
                updateData.lastName = lastName;
            }
        } else if (field === "email") {
            const email = document.getElementById("email").value.trim();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById("email-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("email-error").style.display = "none";
                updateData.email = email;
            }
        } else if (field === "phoneNumber") {
            const phoneNumber = document.getElementById("phone-number").value.trim();
            const countryCode = document.getElementById("country-code").value;
            const fullPhoneNumber = `${countryCode}${phoneNumber}`;
            if (!/^\+\d{10,15}$/.test(fullPhoneNumber)) {
                document.getElementById("phone-number-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("phone-number-error").style.display = "none";
                updateData.phoneNumber = fullPhoneNumber;
            }
        } else if (field === "password") {
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            if (password.length < 6) {
                document.getElementById("password-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("password-error").style.display = "none";
            }
            if (password !== confirmPassword) {
                document.getElementById("confirm-password-error").style.display = "block";
                isValid = false;
            } else {
                document.getElementById("confirm-password-error").style.display = "none";
            }
        }

        if (!isValid) {
            showToast("Please fix the errors in the form.", true);
            return;
        }

        try {
            if (field === "password") {
                await updatePassword(auth.currentUser, document.getElementById("password").value);
                showToast("Password updated successfully");
            } else {
                await setDoc(doc(db, "users", userId), updateData, { merge: true });
                if (field === "name") {
                    userProfile.firstName = updateData.firstName;
                    userProfile.lastName = updateData.lastName;
                } else if (field === "email") {
                    userProfile.email = updateData.email;
                    try {
                        await auth.currentUser.updateEmail(updateData.email);
                    } catch (error) {
                        if (error.code === 'auth/requires-recent-login') {
                            showToast("Please log in again to update email.", true);
                            auth.signOut().then(() => window.location.href = 'login.html');
                            return;
                        }
                        throw error;
                    }
                } else if (field === "phoneNumber") {
                    userPhone = updateData.phoneNumber;
                    userProfile.phoneNumber = updateData.phoneNumber;
                }
                showToast(`${field === "name" ? "Name" : field === "email" ? "Email" : "Phone number"} updated successfully`);
            }
            updateProfileDisplay();
            document.getElementById("profile-form").style.display = "none";
        } catch (error) {
            console.error(`Error updating ${field}:`, error.code, error.message, error.stack);
            const errorField = field === "name" ? "first-name" : field === "email" ? "email" : field === "phoneNumber" ? "phone-number" : "password";
            document.getElementById(`${errorField}-error`).textContent = `Failed to update: ${error.message}`;
            document.getElementById(`${errorField}-error`).style.display = "block";
            showToast(`Failed to update ${field === "password" ? "password" : field === "name" ? "name" : field === "email" ? "email" : "phone number"}: ${error.message}`, true);
        }
    });

    document.getElementById("cancel-profile-btn").addEventListener("click", () => {
        document.getElementById("profile-form").style.display = "none";
        updateProfileDisplay();
    });

    let medications = [];
    function setupRealtimeListeners() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const medQuery = query(
            collection(db, "medications"),
            where("userId", "==", userId),
            where("createdAt", ">=", thirtyDaysAgo.toISOString()),
            limit(50)
        );
        onSnapshot(medQuery, (snapshot) => {
            medications = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.times = Array.isArray(data.times) ? data.times : [];
                medications.push({
                    id: doc.id,
                    ...data,
                    status: data.status || "upcoming",
                    progress: data.progress || 0,
                    lastChecked: data.lastChecked || null,
                    duration: data.duration || null,
                    endDate: data.endDate || null,
                    missedDoses: data.missedDoses || 0,
                    lastReminder: data.lastReminder || null,
                    completedDoses: data.completedDoses || [],
                    remindedDoses: data.remindedDoses || []
                });
            });
            updateMedicationList();
            checkMissedMedications();
        }, (error) => {
            console.error('Medication listener error:', error.message, error.stack);
            if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                showToast('Database configuration issue. Please contact support or try again later.', true);
            } else {
                showToast('Failed to load medications', true);
            }
        });

        const vitalsQuery = query(
            collection(db, "vitals"),
            where("userId", "==", userId),
            where("timestamp", ">=", thirtyDaysAgo.toISOString()),
            limit(50)
        );
        onSnapshot(vitalsQuery, (snapshot) => {
            vitalsData = [];
            snapshot.forEach(doc => vitalsData.push({ id: doc.id, ...doc.data() }));
            updateVitalsChart();
            analyzeVitals();
        }, (error) => {
            console.error('Vitals listener error:', error.message, error.stack);
            if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                showToast('Database configuration issue. Please contact support or try again later.', true);
            } else {
                showToast('Failed to load vitals', true);
            }
        });
    }

    function showAddMedicationModal() {
        document.getElementById("add-medication-modal").style.display = "flex";
        document.getElementById("medication-form-error").style.display = "none";
        updateDurationLabel();
        gsap.from(".modal-content", { duration: 0.5, scale: 0.8, opacity: 0, ease: "power2.out" });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        document.getElementById("time-inputs").innerHTML = `
            <div class="time-input-container">
                <input type="time" class="med-time" required>
            </div>
        `;
        document.getElementById("medication-form").reset();
        document.getElementById("medication-form-error").style.display = "none";
        updateDurationLabel();
    }

    function updateDurationLabel() {
        const frequency = document.getElementById("med-frequency").value;
        document.getElementById("duration-unit").textContent = frequency === "daily" ? "days" : "weeks";
    }

    document.getElementById("add-medication-btn").addEventListener("click", showAddMedicationModal);
    document.getElementById("cancel-medication-btn").addEventListener("click", () => closeModal("add-medication-modal"));
    document.getElementById("med-frequency").addEventListener("change", updateDurationLabel);

    document.getElementById("add-time-btn").addEventListener("click", () => {
        const timeInputs = document.getElementById("time-inputs");
        const newTimeInput = document.createElement("div");
        newTimeInput.className = "time-input-container";
        newTimeInput.innerHTML = `<input type="time" class="med-time" required>`;
        timeInputs.appendChild(newTimeInput);
        gsap.from(newTimeInput, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out" });
    });

    document.getElementById("medication-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const errorMessage = document.getElementById("medication-form-error");
    errorMessage.style.display = "none";
    const timeInputs = document.querySelectorAll(".med-time");
    const times = Array.from(timeInputs).map(input => input.value).filter(time => time);
    const duration = Number(document.getElementById("med-duration").value);
    if (times.length === 0) {
        errorMessage.textContent = "Please add at least one valid time.";
        errorMessage.style.display = "block";
        return;
    }
    if (isNaN(duration) || duration < 1) {
        errorMessage.textContent = "Please enter a valid duration (â‰¥1).";
        errorMessage.style.display = "block";
        return;
    }
    const frequency = document.getElementById("med-frequency").value;
    const endDate = new Date();
    if (frequency === "daily") {
        endDate.setDate(endDate.getDate() + duration);
    } else {
        endDate.setDate(endDate.getDate() + duration * 7);
    }
    const med = {
        name: document.getElementById("med-name").value,
        dosage: document.getElementById("med-dosage").value,
        frequency: frequency,
        times: times,
        status: "upcoming",
        progress: 0,
        lastChecked: null,
        duration: duration,
        createdAt: new Date().toISOString(),
        endDate: endDate.toISOString(),
        missedDoses: 0,
        lastReminder: null,
        completedDoses: [],
        remindedDoses: []
    };
    try {
        await saveMedicationToFirebase(med);
        closeModal("add-medication-modal");
        document.getElementById("medication-form").reset();
        showToast("Medication added successfully");
        scheduleOfflineReminders();
    } catch (error) {
        errorMessage.textContent = error.message.includes("No authenticated user") ? 
            "Please log in again to save medications." : 
            error.message.includes("permission-denied") ? 
            "Permission denied. Please ensure you are logged in with the correct account." : 
            `Failed to save medication: ${error.message}`;
        errorMessage.style.display = "block";
        showToast("Failed to add medication", true);
    }
});
    function updateMedicationList() {
        const list = document.getElementById("medication-list");
        const errorMessage = document.getElementById("medication-error");
        list.innerHTML = "";
        errorMessage.style.display = "none";
        const now = new Date();
        let validMedications = 0;
        medications.forEach((med, index) => {
            if (!Array.isArray(med.times) || med.times.length === 0 || !med.times.every(time => typeof time === 'string')) {
                const div = document.createElement("div");
                div.className = "medication-card inactive";
                div.innerHTML = `
                    <div class="medication-header">
                        <h4>âš ï¸ ${med.name}</h4>
                        <span class="status-badge status-not-taken">Invalid Data</span>
                    </div>
                    <p>Invalid times data. Please delete and re-add this medication.</p>
                    <div class="medication-actions">
                        <button class="btn delete-btn" data-id="${med.id}">Delete</button>
                    </div>
                `;
                list.appendChild(div);
                gsap.from(div, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out", delay: index * 0.1 });
                return;
            }
            validMedications++;
            const isTimeToTake = isWithinTimeWindow(med, now);
            const timesDisplay = med.times.join(", ");
            const nextTime = getNextMedicationTime(med);
            let remainingText = "";
            if (med.endDate) {
                const startDate = new Date(med.createdAt || now);
                const endDate = new Date(med.endDate);
                const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
                const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, totalDuration - daysPassed);
                const unit = med.frequency === "daily" ? "days" : "weeks";
                if (daysRemaining <= 0 && med.status !== "completed") {
                    med.status = "completed";
                    med.progress = 100;
                    setDoc(doc(db, "medications", med.id), med).catch(() => {});
                }
                remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "Completed";
            }
            const div = document.createElement("div");
            div.className = `medication-card ${isTimeToTake ? 'active' : 'inactive'}`;
            div.innerHTML = `
                <div class="medication-header">
                    <h4>${med.name}</h4>
                    <span class="status-badge status-${med.status.replace(' ', '-')}">${med.status.charAt(0).toUpperCase() + med.status.slice(1)}</span>
                </div>
                <div class="medication-details">
                    <p><strong>Dosage:</strong> ${med.dosage}</p>
                    <p><strong>Frequency:</strong> ${med.frequency.charAt(0).toUpperCase() + med.frequency.slice(1)}</p>
                    <p><strong>Times:</strong> ${timesDisplay}${isTimeToTake ? "" : `, Next: ${nextTime || 'N/A'}`}</p>
                    <p><strong>Remaining:</strong> ${remainingText}</p>
                    <p><strong>Missed Doses:</strong> <span style="color: ${med.missedDoses > 0 ? 'var(--error)' : 'inherit'}">${med.missedDoses || 0}</span></p>
                </div>
                <div class="progress-bar"><div class="progress" style="width: ${med.progress}%"></div></div>
                <div class="medication-actions">
                    ${isTimeToTake ? `<button class="btn mark-done-btn" data-index="${index}" data-id="${med.id}">Mark as Taken</button>` : ''}
                    <button class="btn delete-btn" data-id="${med.id}">Delete</button>
                </div>
            `;
            list.appendChild(div);
            gsap.from(div, { duration: 0.5, x: -20, opacity: 0, ease: "power2.out", delay: index * 0.1 });

            if (isTimeToTake) {
                const markBtn = div.querySelector('.mark-done-btn');
                markBtn.addEventListener('click', () => markCompleted(index));
            }
        });
        if (medications.length === 0) {
            list.innerHTML = `<p style="text-align: center; color: var(--text); opacity: 0.7;">No medications found. Add a new medication using the "+" button.</p>`;
            gsap.from(list, { duration: 0.5, opacity: 0, ease: "power2.out" });
        } else if (validMedications === 0 && medications.length > 0) {
            errorMessage.textContent = "No valid medications found. Please delete invalid entries or add new medications.";
            errorMessage.style.display = "block";
            gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
        }

        document.querySelectorAll(".mark-done-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const index = parseInt(btn.getAttribute("data-index"));
                markCompleted(index);
            });
        });

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const docId = btn.getAttribute("data-id");
                try {
                    await deleteMedicationFromFirebase(docId);
                    showToast("Medication deleted successfully");
                    scheduleOfflineReminders();
                } catch (error) {
                    errorMessage.textContent = `Failed to delete medication: ${error.message}`;
                    errorMessage.style.display = "block";
                    gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
                    showToast("Failed to delete medication", true);
                }
            });
        });
    }

    function getNextMedicationTime(med) {
        if (!Array.isArray(med.times) || med.times.length === 0) {
            return null;
        }
        const now = new Date();
        let nextTime = null;
        med.times.forEach(time => {
            if (typeof time !== 'string') return;
            try {
                const [hours, minutes] = time.split(":").map(Number);
                if (isNaN(hours) || isNaN(minutes)) return;
                const medTime = new Date();
                medTime.setHours(hours, minutes, 0, 0);
                if (medTime > now && (!nextTime || medTime < nextTime)) {
                    nextTime = medTime;
                }
            } catch (error) {}
        });
        if (!nextTime && med.frequency === "daily") {
            const firstTime = med.times.find(time => typeof time === 'string');
            if (firstTime) {
                try {
                    const [hours, minutes] = firstTime.split(":").map(Number);
                    if (!isNaN(hours) && !isNaN(minutes)) {
                        nextTime = new Date();
                        nextTime.setDate(nextTime.getDate() + 1);
                        nextTime.setHours(hours, minutes, 0, 0);
                    }
                } catch (error) {}
            }
        }
        return nextTime ? nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : null;
    }

    function isWithinTimeWindow(med, now) {
        if (!Array.isArray(med.times) || med.times.length === 0) {
            return false;
        }
        return med.times.some(time => {
            if (typeof time !== 'string') return false;
            try {
                const [hours, minutes] = time.split(":").map(Number);
                if (isNaN(hours) || isNaN(minutes)) return false;
                const medTime = new Date();
                medTime.setHours(hours, minutes, 0, 0);
                const windowStart = new Date(medTime.getTime() - 5 * 60 * 1000);
                const windowEnd = new Date(medTime.getTime() + 3 * 60 * 60 * 1000);
                return now >= windowStart && now <= windowEnd && med.status === "upcoming";
            } catch (error) {
                return false;
            }
        });
    }

    async function markCompleted(index) {
        const med = medications[index];
        if (!med) return;
        const now = new Date();
        med.completedDoses = med.completedDoses || [];
        med.completedDoses.push(now.toISOString());
        med.lastChecked = now.toISOString();
        const totalDoses = calculateTotalDoses(med);
        med.progress = totalDoses > 0 ? (med.completedDoses.length / totalDoses * 100) : 0;
        med.status = med.progress >= 100 ? "completed" : "upcoming";
        try {
            await setDoc(doc(db, "medications", med.id), med);
            showToast(`Dose marked as taken for ${med.name}`);
            scheduleOfflineReminders();
        } catch (error) {
            const errorMessage = document.getElementById("medication-error");
            errorMessage.textContent = `Failed to update medication status: ${error.message}`;
            errorMessage.style.display = "block";
            gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
            showToast("Failed to mark dose", true);
        }
    }

    function calculateTotalDoses(med) {
        if (!med.createdAt || !med.endDate || !med.times) return 0;
        const startDate = new Date(med.createdAt);
        const endDate = new Date(med.endDate);
        const now = new Date();
        const effectiveEndDate = now < endDate ? now : endDate;
        const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        return med.frequency === "daily" ? days * med.times.length : Math.floor(days / 7) * med.times.length;
    }

    function scheduleOfflineReminders() {
        offlineReminders = [];
        const now = new Date();
        medications.forEach(med => {
            if (med.status === "completed" || !med.times || !Array.isArray(med.times)) return;
            med.times.forEach(time => {
                if (typeof time !== 'string') return;
                try {
                    const [hours, minutes] = time.split(":").map(Number);
                    if (isNaN(hours) || isNaN(minutes)) return;
                    let reminderTime = new Date();
                    reminderTime.setHours(hours, minutes, 0, 0);
                    reminderTime.setTime(reminderTime.getTime() - 5 * 60 * 1000);
                    if (reminderTime < now) {
                        reminderTime.setDate(reminderTime.getDate() + 1);
                    }
                    if (med.frequency === "weekly" && now.getDay() !== 0) return;
                    offlineReminders.push({
                        medId: med.id,
                        name: med.name,
                        dosage: med.dosage,
                        time: time,
                        reminderTime: reminderTime.toISOString()
                    });
                } catch (error) {}
            });
        });
        localStorage.setItem('offlineReminders', JSON.stringify(offlineReminders));
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'SCHEDULE_REMINDERS',
                reminders: offlineReminders
            });
        }
    }

    async function checkMedicationReminders() {
    const now = new Date();
    for (const med of medications) {
        if (med.status === "completed" || !med.times || !Array.isArray(med.times) || med.times.length === 0) continue;
        for (const time of med.times) {
            if (typeof time !== 'string') continue;
            try {
                const [hours, minutes] = time.split(":").map(Number);
                if (isNaN(hours) || isNaN(minutes)) continue;
                const medTime = new Date();
                medTime.setHours(hours, minutes, 0, 0);
                const reminderTime = new Date(medTime.getTime() - 5 * 60 * 1000); // 5 min before
                const postReminderTime = new Date(medTime.getTime() + 5 * 60 * 1000); // 5 min after
                const windowStartBefore = new Date(reminderTime.getTime() - 30 * 1000); // Â±30s
                const windowEndBefore = new Date(reminderTime.getTime() + 30 * 1000);
                const windowStartAfter = new Date(postReminderTime.getTime() - 30 * 1000);
                const windowEndAfter = new Date(postReminderTime.getTime() + 30 * 1000);
                med.remindedDoses = med.remindedDoses || [];
                const reminderKey = `${med.id}_${time}_${medTime.toDateString()}`;
                
                // Send reminder at 5 min before or 5 min after, if not already sent
                if ((now >= windowStartBefore && now <= windowEndBefore || now >= windowStartAfter && now <= windowEndAfter) && !med.remindedDoses.includes(reminderKey)) {
                    const message = `Time to take ${med.name} (${med.dosage}) at ${time}. Reply 'Yes' to confirm, 'No' to skip.`;
                    await sendSMS(message);
                    console.log('Sending SMS:', { to: userPhone, body: message });
                    med.remindedDoses.push(reminderKey);
                    med.lastReminder = now.toISOString();
                    await setDoc(doc(db, "medications", med.id), med).catch(err => console.error('Error saving remindedDoses:', err));
                }
            } catch (error) {
                console.error('Error in checkMedicationReminders:', error);
            }
        }
    }
}
    async function checkMissedMedications() {
        const now = new Date();
        for (const med of medications) {
            if (med.status === "completed" || !Array.isArray(med.times) || med.times.length === 0) continue;
            let updated = false;
            let missedDoses = 0;
            const startDate = new Date(med.createdAt || now);
            const endDate = new Date(med.endDate);
            const effectiveEndDate = now < endDate ? now : endDate;
            const days = Math.floor((effectiveEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            for (let day = 0; day < days; day++) {
                if (med.frequency === "weekly" && day % 7 !== 0) continue;
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + day);
                for (const time of med.times) {
                    if (typeof time !== 'string') continue;
                    try {
                        const [hours, minutes] = time.split(":").map(Number);
                        if (isNaN(hours) || isNaN(minutes)) continue;
                        const doseTime = new Date(currentDate);
                        doseTime.setHours(hours, minutes, 0, 0);
                        const missedWindow = new Date(doseTime.getTime() + 3 * 60 * 60 * 1000);
                        if (now <= missedWindow || doseTime > now) continue;

                        const completed = med.completedDoses && med.completedDoses.some(completedTime => {
                            const completedDate = new Date(completedTime);
                            return completedDate.toDateString() === doseTime.toDateString() &&
                                   completedDate.getHours() === doseTime.getHours() &&
                                   completedDate.getMinutes() === doseTime.getMinutes();
                        });

                        if (!completed) {
                            missedDoses++;
                            updated = true;
                        }
                    } catch (error) {}
                }
            }

            if (med.missedDoses !== missedDoses) {
                med.missedDoses = missedDoses;
                med.status = missedDoses > 0 ? "not taken" : "upcoming";
                updated = true;
            }

            if (updated) {
                try {
                    await setDoc(doc(db, "medications", med.id), med);
                } catch (error) {
                    const errorMessage = document.getElementById("medication-error");
                    errorMessage.textContent = `Failed to update medication status: ${error.message}`;
                    errorMessage.style.display = "block";
                    gsap.from(errorMessage, { duration: 0.5, opacity: 0, y: 10, ease: "power2.out" });
                    showToast("Failed to update medication status", true);
                }
            }
        }
        updateMedicationList();
    }

    let vitalsData = [];
    const ctx = document.getElementById("vitals-chart").getContext("2d");
    const vitalsChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [
                { label: "Systolic BP (mmHg)", data: [], borderColor: "#4CB5AB", fill: false },
                { label: "Diastolic BP (mmHg)", data: [], borderColor: "#FF8566", fill: false },
                { label: "Blood Sugar (mg/dL)", data: [], borderColor: "#333A40", fill: false },
                { label: "Heart Rate (bpm)", data: [], borderColor: "#8e44ad", fill: false },
                { label: "Weight (kg)", data: [], borderColor: "#e67e22", fill: false },
                { label: "Temperature (Â°C)", data: [], borderColor: "#2ecc71", fill: false }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    document.getElementById("vitals-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const inputs = [
            { id: "bp-systolic", value: Number(document.getElementById("bp-systolic").value) },
            { id: "bp-diastolic", value: Number(document.getElementById("bp-diastolic").value) },
            { id: "sugar", value: Number(document.getElementById("sugar").value) },
            { id: "heart-rate", value: Number(document.getElementById("heart-rate").value) },
            { id: "weight", value: Number(document.getElementById("weight").value) },
            { id: "temp", value: Number(document.getElementById("temp").value) }
        ];
        let isValid = true;
        inputs.forEach(input => {
            const errorElement = document.getElementById(`${input.id}-error`);
            if (input.value < 0 || isNaN(input.value)) {
                errorElement.style.display = "block";
                isValid = false;
            } else {
                errorElement.style.display = "none";
            }
        });
        if (!isValid) return;
        const vitals = {
            systolic: inputs[0].value,
            diastolic: inputs[1].value,
            sugar: inputs[2].value,
            heartRate: inputs[3].value,
            weight: inputs[4].value,
            temp: inputs[5].value,
            timestamp: new Date().toISOString()
        };
        try {
            await saveVitalsToFirebase(vitals);
            document.getElementById("vitals-form").reset();
            gsap.from(".vitals-form", { duration: 0.5, scale: 0.95, opacity: 0, ease: "power2.out" });
            showToast("Vitals logged successfully");
        } catch (error) {
            showToast("Failed to log vitals: " + error.message, true);
        }
    });

    function updateVitalsChart() {
        vitalsChart.data.labels = vitalsData.map(v => new Date(v.timestamp).toLocaleDateString());
        vitalsChart.data.datasets[0].data = vitalsData.map(v => v.systolic);
        vitalsChart.data.datasets[1].data = vitalsData.map(v => v.diastolic);
        vitalsChart.data.datasets[2].data = vitalsData.map(v => v.sugar);
        vitalsChart.data.datasets[3].data = vitalsData.map(v => v.heartRate);
        vitalsChart.data.datasets[4].data = vitalsData.map(v => v.weight);
        vitalsChart.data.datasets[5].data = vitalsData.map(v => v.temp);
        vitalsChart.update();
        gsap.from("#vitals-chart", { duration: 1, opacity: 0, scale: 0.95, ease: "power2.out" });
    }

    async function analyzeVitals() {
    const insights = document.getElementById("insights-content");
    insights.innerHTML = "";
    if (vitalsData.length === 0 && medications.length === 0) {
        insights.innerHTML = `<p style="text-align: center; color: var(--text); opacity: 0.7;">No data yet. Add medications or log vitals to see insights.</p>`;
        gsap.from(insights, { duration: 0.5, opacity: 0, y: 20, ease: "power2.out" });
        return;
    }

    insights.innerHTML = `
        <h3>Your Health Summary</h3>
        <p>Based on all logged data as of ${new Date().toLocaleDateString()}.</p>
    `;

    // Medication Adherence
    if (medications.length > 0) {
        const totalDoses = medications.reduce((sum, m) => sum + calculateTotalDoses(m), 0);
        const completedDoses = medications.reduce((sum, m) => sum + (m.completedDoses ? m.completedDoses.length : 0), 0);
        const adherenceRate = totalDoses > 0 ? (completedDoses / totalDoses * 100).toFixed(1) : 0;
        const overdueMeds = medications.filter(m => m.endDate && new Date(m.endDate) < new Date() && m.status !== "completed");
        insights.innerHTML += `
            <h4>Medication Status</h4>
            <p><strong>Adherence:</strong> ${adherenceRate}% (${completedDoses}/${totalDoses} doses taken)</p>
            ${adherenceRate < 80 ? "<p style='color: var(--error);'>âš ï¸ You're missing some doses. Try to take your meds on time or talk to your doctor.</p>" : "<p style='color: var(--success);'>âœ… You're doing great with your meds!</p>"}
            ${overdueMeds.length > 0 ? `<p style='color: var(--error);'>âš ï¸ Overdue: ${overdueMeds.map(m => m.name).join(", ")}. Check with your doctor.</p>` : ""}
        `;
        if (overdueMeds.length > 0 && userPhone) {
            await sendSMS(`Overdue: ${overdueMeds.map(m => m.name).join(", ")}. Check with your doctor.`);
        }
    }

    // Vitals Analysis
    if (vitalsData.length > 0) {
        const validVitals = vitalsData.filter(v => v.systolic != null && v.diastolic != null && v.sugar != null && v.heartRate != null && v.temp != null && v.weight != null);
        if (validVitals.length === 0) {
            insights.innerHTML += `<p style="color: var(--error);">âš ï¸ No valid vitals data. Please log complete vitals entries.</p>`;
            return;
        }

        const avg = {
            systolic: validVitals.reduce((sum, v) => sum + Number(v.systolic), 0) / validVitals.length,
            diastolic: validVitals.reduce((sum, v) => sum + Number(v.diastolic), 0) / validVitals.length,
            sugar: validVitals.reduce((sum, v) => sum + Number(v.sugar), 0) / validVitals.length,
            heartRate: validVitals.reduce((sum, v) => sum + Number(v.heartRate), 0) / validVitals.length,
            temp: validVitals.reduce((sum, v) => sum + Number(v.temp), 0) / validVitals.length,
            weightChange: validVitals.length > 1 ? Math.abs(validVitals[validVitals.length - 1].weight - validVitals[0].weight) / validVitals[0].weight * 100 : 0
        };

        const status = {
            bp: validVitals.some(v => Number(v.systolic) >= 180 || Number(v.diastolic) >= 120) ? "urgent" :
                validVitals.some(v => Number(v.systolic) < 90 && Number(v.diastolic) < 60) ? "low" :
                validVitals.some(v => Number(v.systolic) >= 130 || Number(v.diastolic) >= 80) ? "warning" :
                validVitals.some(v => Number(v.systolic) >= 120 && Number(v.systolic) <= 129 && Number(v.diastolic) < 80) ? "elevated" : "good",
            sugar: validVitals.some(v => Number(v.sugar) < 54 || Number(v.sugar) > 250) ? "urgent" :
                validVitals.some(v => Number(v.sugar) < 70 || Number(v.sugar) > 140) ? "warning" : "good",
            heartRate: validVitals.some(v => Number(v.heartRate) < 60 || Number(v.heartRate) > 100) ? "warning" : "good",
            temp: validVitals.some(v => Number(v.temp) < 35 || Number(v.temp) > 38.5) ? "urgent" :
                validVitals.some(v => Number(v.temp) < 36.1 || Number(v.temp) > 37.2) ? "warning" : "good",
            weight: avg.weightChange > 5 ? "warning" : "good"
        };

        insights.innerHTML += `
            <h4>Your Vitals (All ${validVitals.length} Valid Entries)</h4>
            <p><strong>Blood Pressure:</strong> ${avg.systolic.toFixed(1)}/${avg.diastolic.toFixed(1)} mmHg (Normal: <120/<80, Low: <90/<60)</p>
            <p style="color: ${status.bp === 'urgent' || status.bp === 'low' ? 'var(--error)' : status.bp === 'warning' ? '#e67e22' : status.bp === 'elevated' ? '#f1c40f' : 'var(--success)'};">
                ${status.bp === "urgent" ? "ðŸš¨ High blood pressure! See a doctor now." :
                  status.bp === "low" ? "ðŸš¨ Low blood pressure! Rest and see a doctor if you feel dizzy or faint." :
                  status.bp === "warning" ? "âš ï¸ Blood pressure is high. Watch your diet and stress." :
                  status.bp === "elevated" ? "âš ï¸ Blood pressure is elevated. Monitor closely and consider lifestyle changes." : "âœ… Blood pressure looks good!"}
            </p>
            <p><strong>Blood Sugar:</strong> ${avg.sugar.toFixed(1)} mg/dL (Normal: 70â€“140)</p>
            <p style="color: ${status.sugar === 'urgent' ? 'var(--error)' : status.sugar === 'warning' ? '#e67e22' : 'var(--success)'};">
                ${status.sugar === "urgent" ? "ðŸš¨ Blood sugar is too low or high! Eat something sweet or avoid sugar, then see a doctor." :
                  status.sugar === "warning" ? "âš ï¸ Blood sugar is off. Check your diet and talk to a doctor." : "âœ… Blood sugar looks good!"}
            </p>
            <p><strong>Heart Rate:</strong> ${avg.heartRate.toFixed(1)} bpm (Normal: 60â€“100)</p>
            <p style="color: ${status.heartRate === 'warning' ? '#e67e22' : 'var(--success)'};">
                ${status.heartRate === "warning" ? "âš ï¸ Heart rate is too low or high. Rest and check with a doctor if it continues." : "âœ… Heart rate looks good!"}
            </p>
            <p><strong>Temperature:</strong> ${avg.temp.toFixed(1)} Â°C (Normal: 36.1â€“37.2)</p>
            <p style="color: ${status.temp === 'urgent' ? 'var(--error)' : status.temp === 'warning' ? '#e67e22' : 'var(--success)'};">
                ${status.temp === "urgent" ? "ðŸš¨ Temperature is too low or high! See a doctor now." :
                  status.temp === "warning" ? "âš ï¸ Temperature is off. Keep warm or cool down, and check with a doctor." : "âœ… Temperature looks good!"}
            </p>
            <p><strong>Weight Change:</strong> ${avg.weightChange.toFixed(1)}% (Normal: <5%)</p>
            <p style="color: ${status.weight === 'warning' ? '#e67e22' : 'var(--success)'};">
                ${status.weight === "warning" ? "âš ï¸ Weight changed a lot. Check your diet and activity, and talk to a doctor." : "âœ… Weight is stable!"}
            </p>
            <h4>What to Do Next</h4>
            <ul style="text-align: left;">
                <li>Log vitals every day to keep track.</li>
                <li>Take meds on time to stay healthy.</li>
                <li>If you see ðŸš¨, call a doctor right away.</li>
                <li>If you see âš ï¸, watch for a few days and talk to a doctor if it doesnâ€™t improve.</li>
                <li>Eat well, drink water, and move for 30 minutes daily.</li>
            </ul>
        `;

        const alerts = [];
        if (status.bp === "urgent" || status.bp === "low") alerts.push(status.bp === "urgent" ? "High blood pressure (â‰¥180/â‰¥120 mmHg)" : "Low blood pressure (<90/<60 mmHg)");
        if (status.sugar === "urgent") alerts.push("Blood sugar too low/high (<54 or >250 mg/dL)");
        if (status.temp === "urgent") alerts.push("Temperature too low/high (<35 or >38.5Â°C)");
        if (alerts.length > 0 && userPhone) {
            await sendSMS(`Urgent: ${alerts.join(", ")}. See a doctor now.`);
        }

        gsap.from(insights, { duration: 0.5, y: 20, opacity: 0, ease: "power2.out" });
    }
}
    function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("helvetica", "bold");
    doc.text("ðŸ’ŠMedisync Health Report", 10, 10);
    doc.setFont("helvetica", "normal");
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 10, 20);
    doc.text("Vitals Log:", 10, 30);
    let yPos = 40;
    const vitalsTableData = vitalsData.map(v => [
        new Date(v.timestamp).toLocaleString(),
        v.systolic.toString(),
        v.diastolic.toString(),
        v.sugar.toString(),
        v.heartRate.toString(),
        v.weight.toString(),
        v.temp.toString()
    ]);
    doc.autoTable({
        startY: yPos,
        head: [['Date', 'Systolic BP (mmHg)', 'Diastolic BP (mmHg)', 'Blood Sugar (mg/dL)', 'Heart Rate (bpm)', 'Weight (kg)', 'Temperature (Â°C)']],
        body: vitalsTableData,
        theme: 'grid',
        styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
        headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
        columnStyles: {
            0: { cellWidth: 40 },
            1: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[1]) >= 130) ? [231, 76, 60] : [51, 58, 64] },
            2: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[2]) >= 80) ? [231, 76, 60] : [51, 58, 64] },
            3: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[3]) < 54 || Number(row[3]) > 250) ? [231, 76, 60] : [51, 58, 64] },
            4: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[4]) < 60 || Number(row[4]) > 100) ? [231, 76, 60] : [51, 58, 64] },
            5: { cellWidth: 25, halign: 'center' },
            6: { cellWidth: 25, halign: 'center', textColor: vitalsTableData.some(row => Number(row[6]) < 36.1 || Number(row[6]) > 37.2) ? [231, 76, 60] : [51, 58, 64] }
        },
        margin: { left: 10, right: 10 }
    });
    yPos = doc.lastAutoTable.finalY + 10;
    doc.text("Medications:", 10, yPos);
    yPos += 10;
    const tableData = medications.map(med => {
        const timesDisplay = Array.isArray(med.times) && med.times.length > 0 && med.times.every(time => typeof time === 'string') ? med.times.join(", ") : "No valid times";
        const startDate = new Date(med.createdAt || new Date());
        const endDate = new Date(med.endDate);
        const totalDuration = med.frequency === "daily" ? med.duration : med.duration * 7;
        const daysPassed = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));
        const daysRemaining = Math.max(0, totalDuration - daysPassed);
        const unit = med.frequency === "daily" ? "days" : "weeks";
        const remainingText = daysRemaining > 0 ? `${daysRemaining} ${unit} remaining` : "Completed";
        const statusText = med.status.charAt(0).toUpperCase() + med.status.slice(1);
        return [
            med.name,
            med.dosage,
            med.frequency.charAt(0).toUpperCase() + med.frequency.slice(1),
            timesDisplay,
            statusText,
            remainingText,
            med.missedDoses || 0
        ];
    });
    doc.autoTable({
        startY: yPos,
        head: [['Name', 'Dosage', 'Frequency', 'Times', 'Status', 'Remaining', 'Missed Doses']],
        body: tableData,
        theme: 'grid',
        styles: { font: 'helvetica', fontSize: 8, textColor: [51, 58, 64] },
        headStyles: { fillColor: [76, 181, 171], textColor: [255, 255, 255], font: 'helvetica', fontStyle: 'bold' },
        columnStyles: {
            0: { cellWidth: 30 },
            1: { cellWidth: 25 },
            2: { cellWidth: 20 },
            3: { cellWidth: 40 },
            4: { cellWidth: 25, halign: 'center' },
            5: { cellWidth: 30 },
            6: { cellWidth: 20, halign: 'center', textColor: tableData.some(row => row[6] > 0) ? [231, 76, 60] : [51, 58, 64] }
        },
        margin: { left: 10, right: 10 }
    });
    doc.save("Medisync_Health_Report.pdf");
}
    document.getElementById("export-pdf-btn").addEventListener("click", exportToPDF);

    async function sendSMS(message) {
        if (!userPhone) {
            console.error("No phone number available for SMS");
            showToast("No phone number available for SMS", true);
            return;
        }

        if (!/^\+\d{10,15}$/.test(userPhone)) {
            console.error("Invalid phone number format:", userPhone);
            showToast("Invalid phone number format", true);
            return;
        }

        try {
            const response = await fetch('https://medisync-backend-1-o8mt.onrender.com/send-sms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer my-unique-token-123'
                },
                body: JSON.stringify({
                    to: userPhone,
                    body: message
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Failed to send SMS');
            }

            console.log('SMS sent successfully:', data.sid);
            showToast("SMS sent successfully");
        } catch (error) {
            console.error('Error sending SMS:', error);
            showToast(`Failed to send SMS: ${error.message}`, true);
        }
    }

    setInterval(checkMedicationReminders, 30 * 1000);

    if ('Notification' in window && Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Notification permission granted');
            }
        });
    }

    function showNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: body,
                icon: '/favicon.ico'
            });
        }
    }

    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'REMINDER') {
            const { medId, name, dosage, time } = event.data.reminder;
            showNotification('Medication Reminder', `Time to take ${name} (${dosage}) at ${time}`);
            const med = medications.find(m => m.id === medId);
            if (med) {
                med.remindedDoses = med.remindedDoses || [];
                const reminderKey = `${medId}_${time}_${new Date().toDateString()}`;
                if (!med.remindedDoses.includes(reminderKey)) {
                    med.remindedDoses.push(reminderKey);
                    med.lastReminder = new Date().toISOString();
                    setDoc(doc(db, "medications", med.id), med).catch(() => {});
                }
            }
        }
    });

    function checkVitalsReminder() {
        const now = new Date();
        if (!lastVitalsReminderDate || (now - new Date(lastVitalsReminderDate)) > 24 * 60 * 60 * 1000) {
            const lastVitals = vitalsData.length > 0 ? new Date(vitalsData[vitalsData.length - 1].timestamp) : null;
            if (!lastVitals || (now - lastVitals) > 24 * 60 * 60 * 1000) {
                sendSMS("Reminder: Log your vital signs today to keep track of your health.");
                lastVitalsReminderDate = now.toISOString();
                localStorage.setItem('lastVitalsReminderDate', lastVitalsReminderDate);
            }
        }
    }

    setInterval(checkVitalsReminder, 60 * 60 * 1000);

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            checkMedicationReminders();
            checkVitalsReminder();
        }
    });

    if (localStorage.getItem('lastVitalsReminderDate')) {
        lastVitalsReminderDate = localStorage.getItem('lastVitalsReminderDate');
    }
});
</script>
</body>
</html>
